<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RAPPERSTORE: MELODY MASTER PRO</title>
    
    <!-- Tone.js for professional audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #020206;
            --bg-secondary: #0a0a18;
            --bg-card: rgba(15, 15, 30, 0.9);
            --text: #ffffff;
            --text-dim: #667788;
            --accent: #00f0ff;
            --accent-secondary: #ff00aa;
            --accent-tertiary: #aaff00;
            --accent-gold: #ffcc00;
            --perfect: #00ff88;
            --good: #88ff00;
            --miss: #ff4466;
            --energy: #7700ff;
            
            /* Instrument Colors */
            --piano-primary: #00f0ff;
            --piano-secondary: #0088aa;
            --guitar-primary: #ff8800;
            --guitar-secondary: #aa5500;
            --drums-primary: #ff00aa;
            --drums-secondary: #aa0066;
            
            /* Key Colors */
            --white-key: linear-gradient(180deg, #ffffff 0%, #e8e8e8 50%, #d0d0d0 100%);
            --white-key-active: linear-gradient(180deg, #00f0ff 0%, #00ccdd 50%, #00aacc 100%);
            --black-key: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 50%, #0a0a0a 100%);
            --black-key-active: linear-gradient(180deg, #ff00aa 0%, #cc0088 50%, #990066 100%);
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
        }

        .main-container {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            overflow: hidden;
            position: relative;
        }

        /* ============== PARALLAX STARS ============== */
        .parallax-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: starTwinkle linear infinite;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* ============== NEBULA CLOUDS ============== */
        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.12;
            animation: nebulaDrift 30s ease-in-out infinite;
            pointer-events: none;
        }

        .nebula-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, var(--accent-secondary), transparent);
            top: -10%; left: -15%;
        }

        .nebula-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, var(--accent), transparent);
            bottom: -10%; right: -10%;
            animation-delay: -15s;
        }

        .nebula-3 {
            width: 300px; height: 300px;
            background: radial-gradient(circle, var(--energy), transparent);
            top: 40%; left: 40%;
            animation-delay: -7s;
        }

        @keyframes nebulaDrift {
            0%, 100% { transform: translate(0, 0) scale(1); opacity: 0.1; }
            50% { transform: translate(30px, 20px) scale(1.15); opacity: 0.18; }
        }

        /* ============== AUDIO VISUALIZER ============== */
        .audio-visualizer {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            pointer-events: none;
            z-index: 2;
            opacity: 0.3;
        }

        .viz-bar {
            width: 4px;
            background: linear-gradient(180deg, var(--accent), var(--accent-secondary));
            border-radius: 2px 2px 0 0;
            transition: height 0.05s ease;
            min-height: 3px;
        }

        /* ============== GRID FLOOR ============== */
        .grid-floor {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 120px;
            background: 
                linear-gradient(transparent 0%, rgba(0, 240, 255, 0.03) 50%, rgba(0, 240, 255, 0.1) 100%),
                repeating-linear-gradient(90deg, transparent, transparent 58px, rgba(0, 240, 255, 0.2) 58px, rgba(0, 240, 255, 0.2) 60px),
                repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0, 240, 255, 0.1) 28px, rgba(0, 240, 255, 0.1) 30px);
            transform: perspective(500px) rotateX(60deg);
            transform-origin: bottom center;
            z-index: 1;
        }

        /* ============== VIGNETTE & OVERLAYS ============== */
        .vignette {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.7) 100%);
            pointer-events: none;
            z-index: 150;
        }

        .scanlines {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0, 0, 0, 0.08) 2px, rgba(0, 0, 0, 0.08) 4px);
            pointer-events: none;
            z-index: 160;
            opacity: 0.4;
        }

        .screen-flash {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 200;
            opacity: 0;
        }

        .screen-flash.perfect {
            background: radial-gradient(ellipse at center, var(--perfect) 0%, transparent 70%);
            animation: flashEffect 0.3s ease-out;
        }

        .screen-flash.good {
            background: radial-gradient(ellipse at center, var(--good) 0%, transparent 70%);
            animation: flashEffect 0.25s ease-out;
        }

        .screen-flash.miss {
            background: radial-gradient(ellipse at center, var(--miss) 0%, transparent 70%);
            animation: flashEffect 0.3s ease-out;
        }

        .screen-flash.note {
            background: radial-gradient(ellipse at center, var(--accent) 0%, transparent 60%);
            animation: flashNote 0.15s ease-out;
        }

        @keyframes flashEffect {
            0% { opacity: 0.5; }
            100% { opacity: 0; }
        }

        @keyframes flashNote {
            0% { opacity: 0.2; }
            100% { opacity: 0; }
        }

        /* ============== SCREENS ============== */
        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        .screen.active { display: flex; }

        /* ============== LOADING OVERLAY ============== */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px; height: 80px;
            position: relative;
            margin-bottom: 25px;
        }

        .loader-ring {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: 4px solid transparent;
            border-radius: 50%;
        }

        .loader-ring:nth-child(1) {
            border-top-color: var(--accent);
            animation: loaderSpin 1s linear infinite;
        }

        .loader-ring:nth-child(2) {
            border-right-color: var(--accent-secondary);
            animation: loaderSpin 1.5s linear infinite reverse;
        }

        .loader-ring:nth-child(3) {
            top: 15px; left: 15px;
            width: calc(100% - 30px); height: calc(100% - 30px);
            border-bottom-color: var(--accent-tertiary);
            animation: loaderSpin 2s linear infinite;
        }

        @keyframes loaderSpin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 0.75rem;
            letter-spacing: 6px;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .loading-status {
            font-size: 0.6rem;
            color: var(--accent);
            letter-spacing: 2px;
        }        /* ============== MENU SCREEN ============== */
        #menu-screen {
            justify-content: flex-start;
            align-items: center;
            padding: 15px;
            padding-top: 20px;
            overflow-y: auto;
        }

        .menu-container {
            text-align: center;
            width: 100%;
            max-width: 550px;
            animation: menuFadeIn 0.8s ease-out;
            z-index: 10;
        }

        @keyframes menuFadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============== LOGO ============== */
        .logo-container {
            padding: 10px 5px 15px;
            position: relative;
        }

        .logo-backdrop {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150%;
            height: 300%;
            background: radial-gradient(ellipse at center, rgba(255, 0, 170, 0.15) 0%, transparent 50%);
            animation: logoBackdropPulse 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes logoBackdropPulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        .logo-text {
            font-size: clamp(1.3rem, 5vw, 2.2rem);
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(180deg, #ff00aa 0%, #ff0066 50%, #ffffff 100%);
            background-size: 100% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: logoShine 2s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255, 0, 170, 0.8));
        }

        @keyframes logoShine {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 0% 100%; }
        }

        .game-title {
            font-size: clamp(1.4rem, 6vw, 2.5rem);
            font-weight: 900;
            letter-spacing: 4px;
            margin-top: 5px;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary), var(--accent-tertiary), var(--accent));
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGradient 4s linear infinite;
            filter: drop-shadow(0 0 15px var(--accent));
        }

        @keyframes titleGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }

        .logo-underline {
            display: block;
            margin: 10px auto 0;
            width: 0%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--accent-secondary), var(--accent), transparent);
            border-radius: 2px;
            animation: underlineExpand 1s ease-out 0.5s forwards;
            box-shadow: 0 0 15px var(--accent);
        }

        @keyframes underlineExpand {
            from { width: 0%; opacity: 0; }
            to { width: 70%; opacity: 1; }
        }

        .tagline {
            font-size: 0.55rem;
            letter-spacing: 3px;
            color: var(--text-dim);
            margin-top: 10px;
            text-transform: uppercase;
        }

        .tagline span {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        /* ============== STATS ROW ============== */
        .stats-row {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.06), rgba(255, 0, 170, 0.06));
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 12px;
            padding: 10px 18px;
            flex: 1;
            max-width: 140px;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        }

        .stat-box-label {
            font-size: 0.5rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .stat-box-value {
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
        }

        /* ============== INSTRUMENT SELECTION ============== */
        .instrument-section {
            margin: 15px 0;
        }

        .section-title {
            font-size: 0.65rem;
            letter-spacing: 4px;
            color: var(--accent);
            margin-bottom: 12px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .section-title::before,
        .section-title::after {
            content: '';
            width: 30px;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent));
        }

        .section-title::after {
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .instrument-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        @media (max-width: 500px) {
            .instrument-grid {
                grid-template-columns: 1fr;
            }
        }

        .instrument-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 18px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .instrument-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.03) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .instrument-card:hover::before {
            opacity: 1;
        }

        .instrument-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .instrument-card.piano:hover,
        .instrument-card.piano.selected {
            border-color: var(--piano-primary);
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.3);
        }

        .instrument-card.guitar:hover,
        .instrument-card.guitar.selected {
            border-color: var(--guitar-primary);
            box-shadow: 0 0 30px rgba(255, 136, 0, 0.3);
        }

        .instrument-card.drums:hover,
        .instrument-card.drums.selected {
            border-color: var(--drums-primary);
            box-shadow: 0 0 30px rgba(255, 0, 170, 0.3);
        }

        .instrument-card.selected {
            transform: translateY(-3px);
        }

        .instrument-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 8px; right: 10px;
            font-size: 0.8rem;
            color: var(--perfect);
            text-shadow: 0 0 10px var(--perfect);
        }

        .instrument-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .instrument-name {
            font-size: 0.9rem;
            font-weight: 800;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .instrument-desc {
            font-size: 0.55rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* ============== SOUND PACK SELECTION ============== */
        .soundpack-section {
            margin: 15px 0;
        }

        .soundpack-grid {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .soundpack-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }

        .soundpack-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .soundpack-btn.selected {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            border-color: transparent;
            color: white;
            box-shadow: 0 5px 20px rgba(0, 240, 255, 0.3);
        }

        /* ============== MODE SELECTION ============== */
        .mode-section {
            margin: 15px 0;
        }

        .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        @media (max-width: 400px) {
            .mode-grid {
                grid-template-columns: 1fr;
            }
        }

        .mode-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 16px 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.08), transparent);
            transition: left 0.5s ease;
        }

        .mode-card:hover::before {
            left: 100%;
        }

        .mode-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 240, 255, 0.15);
        }

        .mode-badge {
            position: absolute;
            top: 8px; right: 8px;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.45rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-badge.popular {
            background: linear-gradient(135deg, var(--accent-gold), #ff8800);
            color: black;
        }

        .mode-badge.new {
            background: linear-gradient(135deg, var(--accent-secondary), #ff4488);
            color: white;
        }

        .mode-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .mode-icon {
            font-size: 1.5rem;
        }

        .mode-title {
            font-size: 0.9rem;
            font-weight: 800;
        }

        .mode-desc {
            font-size: 0.6rem;
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* ============== BUTTONS ============== */
        .btn {
            padding: 14px 28px;
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 3px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            box-shadow: 0 5px 25px rgba(0, 240, 255, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 35px rgba(0, 240, 255, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            border: 2px solid rgba(255, 255, 255, 0.12);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 5px 20px rgba(0, 240, 255, 0.2);
        }

        .btn-large {
            width: 100%;
            padding: 18px 32px;
            font-size: 1rem;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Background Effects -->
        <div class="parallax-layer" id="stars-layer"></div>
        <div class="nebula nebula-1"></div>
        <div class="nebula nebula-2"></div>
        <div class="nebula nebula-3"></div>
        <div class="audio-visualizer" id="audio-visualizer"></div>
        <div class="grid-floor"></div>
        <div class="vignette"></div>
        <div class="scanlines"></div>
        <div class="screen-flash" id="screen-flash"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading">
            <div class="loader">
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
                <div class="loader-ring"></div>
            </div>
            <div class="loading-text">LOADING</div>
            <div class="loading-status" id="loading-status">Initializing audio engine...</div>
        </div>

        <!-- ============== MENU SCREEN ============== -->
        <div id="menu-screen" class="screen active">
            <div class="menu-container">
                <div class="logo-container">
                    <div class="logo-backdrop"></div>
                    <div class="logo-text">RAPPERSTORE</div>
                    <div class="game-title">MELODY MASTER</div>
                    <span class="logo-underline"></span>
                    <p class="tagline">Professional <span>instruments</span> ‚Ä¢ Learn by ear</p>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-box-label">Best Score</div>
                        <div class="stat-box-value" id="stat-best-score">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Accuracy</div>
                        <div class="stat-box-value" id="stat-accuracy">-%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Songs Played</div>
                        <div class="stat-box-value" id="stat-songs">0</div>
                    </div>
                </div>

                <!-- Instrument Selection -->
                <div class="instrument-section">
                    <div class="section-title">üéµ Select Instrument</div>
                    <div class="instrument-grid">
                        <div class="instrument-card piano selected" data-instrument="piano">
                            <span class="instrument-icon">üéπ</span>
                            <div class="instrument-name">Piano</div>
                            <div class="instrument-desc">Classic keys with realistic grand piano sound</div>
                        </div>
                        <div class="instrument-card guitar" data-instrument="guitar">
                            <span class="instrument-icon">üé∏</span>
                            <div class="instrument-name">Guitar</div>
                            <div class="instrument-desc">Acoustic & electric guitar with chord strumming</div>
                        </div>
                        <div class="instrument-card drums" data-instrument="drums">
                            <span class="instrument-icon">ü•Å</span>
                            <div class="instrument-name">Drum Pad</div>
                            <div class="instrument-desc">808 & trap style drum machine beats</div>
                        </div>
                    </div>
                </div>

                <!-- Sound Pack Selection -->
                <div class="soundpack-section" id="soundpack-section">
                    <div class="section-title">üîä Sound Pack</div>
                    <div class="soundpack-grid" id="soundpack-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Mode Selection -->
                <div class="mode-section">
                    <div class="section-title">üéÆ Game Mode</div>
                    <div class="mode-grid">
                        <div class="mode-card" data-mode="listen">
                            <span class="mode-badge popular">POPULAR</span>
                            <div class="mode-card-header">
                                <span class="mode-icon">üéß</span>
                                <span class="mode-title">Listen & Play</span>
                            </div>
                            <p class="mode-desc">Hear a melody, play it back from memory</p>
                        </div>
                        <div class="mode-card" data-mode="chord">
                            <span class="mode-badge new">NEW</span>
                            <div class="mode-card-header">
                                <span class="mode-icon">üéº</span>
                                <span class="mode-title">Chord Master</span>
                            </div>
                            <p class="mode-desc">Learn and play chords quickly</p>
                        </div>
                        <div class="mode-card" data-mode="rhythm">
                            <div class="mode-card-header">
                                <span class="mode-icon">ü•Å</span>
                                <span class="mode-title">Rhythm Rush</span>
                            </div>
                            <p class="mode-desc">Match the beat patterns in time</p>
                        </div>
                        <div class="mode-card" data-mode="freeplay">
                            <div class="mode-card-header">
                                <span class="mode-icon">‚ú®</span>
                                <span class="mode-title">Free Play</span>
                            </div>
                            <p class="mode-desc">Practice freely, no scoring</p>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary btn-large" id="start-btn">
                    üöÄ START PLAYING
                </button>
            </div>
        </div>        <!-- ============== GAME SCREEN ============== -->
        <div id="game-screen" class="screen">
            <!-- Game HUD -->
            <div class="game-hud">
                <div class="hud-left">
                    <div class="song-display">
                        <h2 id="game-title">Free Play</h2>
                        <p id="game-mode-label">PIANO ‚Ä¢ GRAND</p>
                    </div>
                </div>
                <div class="hud-center">
                    <div class="score-container">
                        <div class="score-label">SCORE</div>
                        <div class="score-value" id="score-value">0</div>
                    </div>
                    <div class="multiplier-container">
                        <span class="multiplier-label">COMBO</span>
                        <span class="multiplier-value" id="combo-value">0x</span>
                        <div class="multiplier-bar">
                            <div class="multiplier-fill" id="combo-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="accuracy-container">
                        <div class="accuracy-label">ACCURACY</div>
                        <div class="accuracy-value" id="accuracy-value">100%</div>
                    </div>
                    <div class="streak-display">
                        <span id="streak-value">0</span> streak
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="game-progress">
                <div class="game-progress-bar" id="game-progress-bar"></div>
                <div class="game-progress-text" id="game-progress-text">0 / 0</div>
            </div>

            <!-- Target Display Area -->
            <div class="target-area" id="target-area">
                <div class="target-instruction" id="target-instruction">Listen carefully...</div>
                <div class="target-notes-display" id="target-notes-display"></div>
            </div>

            <!-- Listen Mode Indicator -->
            <div class="listen-indicator" id="listen-indicator">
                <div class="listen-icon">üéß</div>
                <div class="listen-text">LISTEN...</div>
                <div class="listen-wave">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
            </div>

            <!-- Feedback Popup -->
            <div class="feedback-popup" id="feedback-popup"></div>

            <!-- Countdown -->
            <div class="countdown-display" id="countdown-display"></div>

            <!-- Instrument Containers -->
            <div class="instrument-container" id="piano-container">
                <div class="instrument-wrapper piano-wrapper">
                    <div class="instrument-brand">‚ô™ RAPPERSTORE KEYS ‚ô™</div>
                    <div class="piano-keys" id="piano-keys"></div>
                    <div class="keyboard-hints">
                        <span>Use keys A-L for white keys, W-P for black keys</span>
                    </div>
                </div>
            </div>

            <div class="instrument-container" id="guitar-container" style="display: none;">
                <div class="instrument-wrapper guitar-wrapper">
                    <div class="instrument-brand">‚ô™ RAPPERSTORE STRINGS ‚ô™</div>
                    <div class="guitar-fretboard" id="guitar-fretboard"></div>
                    <div class="guitar-chord-display">
                        <div class="chord-name" id="guitar-chord-name">-</div>
                        <div class="chord-diagram" id="chord-diagram"></div>
                    </div>
                    <div class="strum-area" id="strum-area">
                        <div class="strum-hint">STRUM HERE</div>
                        <div class="strum-strings">
                            <div class="strum-string" data-string="E2"></div>
                            <div class="strum-string" data-string="A2"></div>
                            <div class="strum-string" data-string="D3"></div>
                            <div class="strum-string" data-string="G3"></div>
                            <div class="strum-string" data-string="B3"></div>
                            <div class="strum-string" data-string="E4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="instrument-container" id="drums-container" style="display: none;">
                <div class="instrument-wrapper drums-wrapper">
                    <div class="instrument-brand">‚ô™ RAPPERSTORE 808 ‚ô™</div>
                    <div class="drum-machine" id="drum-machine">
                        <div class="drum-pad-grid" id="drum-pad-grid"></div>
                    </div>
                    <div class="drum-controls">
                        <div class="bpm-control">
                            <span class="bpm-label">BPM</span>
                            <input type="range" id="bpm-slider" min="60" max="180" value="120">
                            <span class="bpm-value" id="bpm-value">120</span>
                        </div>
                    </div>
                </div>
            </div>

            <button class="back-btn" id="game-back-btn">‚Üê EXIT</button>
        </div>

        <!-- ============== RESULTS SCREEN ============== -->
        <div id="results-screen" class="screen">
            <div class="results-container">
                <div class="results-header">
                    <div class="results-icon" id="results-icon">üéµ</div>
                    <div class="results-title">SONG COMPLETE!</div>
                    <div class="results-song" id="results-song-name">Song Name</div>
                </div>

                <div class="results-grade-section">
                    <div class="results-grade" id="results-grade">S</div>
                </div>

                <div class="results-new-record" id="results-new-record">
                    üèÜ NEW HIGH SCORE! üèÜ
                </div>

                <div class="results-stats">
                    <div class="results-stat-row highlight">
                        <span class="stat-label">Final Score</span>
                        <span class="stat-value" id="results-score">0</span>
                    </div>
                    <div class="results-stat-row">
                        <span class="stat-label">Accuracy</span>
                        <span class="stat-value" id="results-accuracy">0%</span>
                    </div>
                    <div class="results-stat-row">
                        <span class="stat-label">Perfect Notes</span>
                        <span class="stat-value" id="results-perfect">0</span>
                    </div>
                    <div class="results-stat-row">
                        <span class="stat-label">Good Notes</span>
                        <span class="stat-value" id="results-good">0</span>
                    </div>
                    <div class="results-stat-row">
                        <span class="stat-label">Missed</span>
                        <span class="stat-value" id="results-missed">0</span>
                    </div>
                    <div class="results-stat-row">
                        <span class="stat-label">Max Combo</span>
                        <span class="stat-value" id="results-max-combo">0x</span>
                    </div>
                </div>

                <div class="results-buttons">
                    <button class="btn btn-primary" id="results-retry-btn">üîÑ PLAY AGAIN</button>
                    <button class="btn btn-secondary" id="results-menu-btn">üìã BACK TO MENU</button>
                </div>
            </div>
        </div>

        <!-- ============== SONG SELECT MODAL ============== -->
        <div class="modal-overlay" id="song-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üéµ Select Song</h2>
                    <button class="modal-close" id="modal-close">‚úï</button>
                </div>
                <div class="song-list" id="song-list"></div>
            </div>
        </div>
    </div>

    <style>
        /* ============== GAME HUD ============== */
        .game-hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 50;
            background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 70%, transparent 100%);
        }

        .hud-left, .hud-center, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-center {
            align-items: center;
            flex: 1;
        }

        .hud-right {
            align-items: flex-end;
        }

        .song-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 240, 255, 0.2);
            border-radius: 10px;
            padding: 8px 14px;
        }

        .song-display h2 {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .song-display p {
            font-size: 0.5rem;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .score-container {
            text-align: center;
        }

        .score-label, .accuracy-label, .multiplier-label {
            font-size: 0.45rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .score-value {
            font-size: clamp(1.8rem, 6vw, 2.8rem);
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 25px var(--accent);
            font-family: 'Courier New', monospace;
            line-height: 1;
        }

        .score-value.bump {
            animation: scoreBump 0.2s ease;
        }

        @keyframes scoreBump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .multiplier-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .multiplier-value {
            font-size: 1rem;
            font-weight: 900;
            color: var(--accent-tertiary);
            text-shadow: 0 0 10px var(--accent-tertiary);
        }

        .multiplier-value.fire {
            color: #ff6600;
            text-shadow: 0 0 15px #ff4400;
            animation: firePulse 0.2s ease infinite alternate;
        }

        @keyframes firePulse {
            from { filter: brightness(1); }
            to { filter: brightness(1.5); }
        }

        .multiplier-bar {
            width: 60px;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
            border: 1px solid rgba(170, 255, 0, 0.3);
        }

        .multiplier-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-tertiary), #ffff00);
            border-radius: 2px;
            width: 0%;
            transition: width 0.2s ease;
            box-shadow: 0 0 8px var(--accent-tertiary);
        }

        .accuracy-container {
            text-align: right;
        }

        .accuracy-value {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--perfect);
            text-shadow: 0 0 15px var(--perfect);
        }

        .streak-display {
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .streak-display span {
            color: var(--accent-gold);
            font-weight: 800;
        }

        /* ============== GAME PROGRESS ============== */
        .game-progress {
            position: absolute;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            width: min(350px, 80vw);
            z-index: 50;
        }

        .game-progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .game-progress-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary), var(--accent-tertiary));
            border-radius: 3px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--accent);
        }

        .game-progress-text {
            text-align: center;
            font-size: 0.55rem;
            color: var(--text-dim);
            margin-top: 4px;
            letter-spacing: 1px;
        }

        /* ============== TARGET AREA ============== */
        .target-area {
            position: absolute;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            width: min(500px, 90vw);
            text-align: center;
            z-index: 40;
        }

        .target-instruction {
            font-size: 0.75rem;
            letter-spacing: 3px;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .target-notes-display {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            min-height: 80px;
        }

        .target-note {
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, rgba(0, 240, 255, 0.15), rgba(255, 0, 170, 0.15));
            border: 3px solid var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent);
            animation: targetPulse 1s ease-in-out infinite;
            transition: all 0.2s ease;
        }

        @keyframes targetPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(0, 240, 255, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 35px rgba(0, 240, 255, 0.5); }
        }

        .target-note.correct {
            background: linear-gradient(135deg, var(--perfect), #00aa55);
            border-color: var(--perfect);
            color: white;
            animation: noteCorrect 0.4s ease forwards;
        }

        .target-note.wrong {
            background: linear-gradient(135deg, var(--miss), #aa0033);
            border-color: var(--miss);
            animation: noteWrong 0.4s ease;
        }

        @keyframes noteCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); }
            100% { transform: scale(1); opacity: 0.7; }
        }

        @keyframes noteWrong {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-12px); }
            40% { transform: translateX(12px); }
            60% { transform: translateX(-8px); }
            80% { transform: translateX(8px); }
        }

        /* ============== LISTEN INDICATOR ============== */
        .listen-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 55;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .listen-indicator.active {
            opacity: 1;
        }

        .listen-icon {
            font-size: 4rem;
            animation: listenBounce 1s ease-in-out infinite;
        }

        @keyframes listenBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .listen-text {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--accent);
            letter-spacing: 6px;
            margin-top: 10px;
            text-shadow: 0 0 20px var(--accent);
        }

        .listen-wave {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 15px;
        }

        .listen-wave span {
            width: 6px;
            height: 25px;
            background: var(--accent);
            border-radius: 3px;
            animation: waveBar 0.8s ease-in-out infinite;
        }

        .listen-wave span:nth-child(1) { animation-delay: 0s; }
        .listen-wave span:nth-child(2) { animation-delay: 0.1s; }
        .listen-wave span:nth-child(3) { animation-delay: 0.2s; }
        .listen-wave span:nth-child(4) { animation-delay: 0.3s; }
        .listen-wave span:nth-child(5) { animation-delay: 0.4s; }

        @keyframes waveBar {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 35px; opacity: 1; }
        }

        /* ============== FEEDBACK POPUP ============== */
        .feedback-popup {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(2.5rem, 10vw, 4.5rem);
            font-weight: 900;
            opacity: 0;
            pointer-events: none;
            z-index: 60;
            text-shadow: 0 0 40px currentColor;
        }

        .feedback-popup.perfect {
            color: var(--perfect);
            animation: feedbackPop 0.6s ease-out forwards;
        }

        .feedback-popup.good {
            color: var(--good);
            animation: feedbackPop 0.5s ease-out forwards;
        }

        .feedback-popup.miss {
            color: var(--miss);
            animation: feedbackPop 0.5s ease-out forwards;
        }

        @keyframes feedbackPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            25% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -70%) scale(1); }
        }

        /* ============== COUNTDOWN ============== */
        .countdown-display {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(6rem, 25vw, 12rem);
            font-weight: 900;
            color: var(--accent);
            text-shadow: 0 0 60px var(--accent), 0 0 120px var(--accent);
            z-index: 200;
            opacity: 0;
            pointer-events: none;
        }

        .countdown-display.show {
            animation: countdownPop 0.9s ease-out forwards;
        }

        @keyframes countdownPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(5) rotate(-10deg); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        /* ============== INSTRUMENT CONTAINER ============== */
        .instrument-container {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 45;
        }

        .instrument-wrapper {
            background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
            border: 3px solid rgba(0, 240, 255, 0.25);
            border-radius: 20px;
            padding: 15px 20px 20px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.9),
                0 0 50px rgba(0, 240, 255, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .instrument-brand {
            text-align: center;
            font-size: 0.55rem;
            letter-spacing: 4px;
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent);
            margin-bottom: 12px;
        }

        .keyboard-hints {
            text-align: center;
            margin-top: 10px;
            font-size: 0.55rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        /* ============== PIANO KEYS ============== */
        .piano-keys {
            display: flex;
            position: relative;
            height: clamp(130px, 28vh, 200px);
        }

        .piano-key {
            cursor: pointer;
            position: relative;
            transition: all 0.06s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }

        .piano-key.white {
            width: clamp(34px, 6.5vw, 52px);
            height: 100%;
            background: var(--white-key);
            border: 1px solid #aaa;
            border-radius: 0 0 8px 8px;
            margin-right: 2px;
            box-shadow: 
                0 8px 15px rgba(0, 0, 0, 0.4),
                inset 0 -8px 20px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            z-index: 1;
        }

        .piano-key.white:last-child {
            margin-right: 0;
        }

        .piano-key.white:hover {
            background: linear-gradient(180deg, #f5f5f5 0%, #e5e5e5 50%, #d8d8d8 100%);
        }

        .piano-key.white.active {
            background: var(--white-key-active);
            transform: translateY(4px);
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.3),
                0 0 35px rgba(0, 240, 255, 0.6),
                inset 0 -4px 10px rgba(0, 0, 0, 0.1);
        }

        .piano-key.white.highlight {
            animation: whiteKeyGlow 0.6s ease infinite;
        }

        @keyframes whiteKeyGlow {
            0%, 100% { box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 25px rgba(0, 240, 255, 0.4); }
            50% { box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4), 0 0 45px rgba(0, 240, 255, 0.7); }
        }

        .piano-key.black {
            width: clamp(22px, 4.5vw, 34px);
            height: 60%;
            background: var(--black-key);
            border: 1px solid #000;
            border-radius: 0 0 5px 5px;
            position: absolute;
            top: 0;
            z-index: 10;
            box-shadow: 
                0 8px 12px rgba(0, 0, 0, 0.6),
                inset 0 -5px 10px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .piano-key.black:hover {
            background: linear-gradient(180deg, #3a3a3a 0%, #2a2a2a 50%, #1a1a1a 100%);
        }

        .piano-key.black.active {
            background: var(--black-key-active);
            transform: translateY(3px);
            box-shadow: 
                0 4px 6px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(255, 0, 170, 0.6),
                inset 0 -2px 5px rgba(255, 255, 255, 0.05);
        }

        .piano-key.black.highlight {
            animation: blackKeyGlow 0.6s ease infinite;
        }

        @keyframes blackKeyGlow {
            0%, 100% { box-shadow: 0 8px 12px rgba(0, 0, 0, 0.6), 0 0 25px rgba(255, 0, 170, 0.5); }
            50% { box-shadow: 0 8px 12px rgba(0, 0, 0, 0.6), 0 0 45px rgba(255, 0, 170, 0.8); }
        }

        .key-label {
            font-size: clamp(0.55rem, 1.2vw, 0.75rem);
            font-weight: 700;
            pointer-events: none;
            transition: color 0.1s ease;
        }

        .piano-key.white .key-label {
            color: #666;
        }

        .piano-key.black .key-label {
            color: #888;
            padding-bottom: 5px;
        }

        .piano-key.active .key-label {
            color: white;
        }

        /* ============== GUITAR ============== */
        .guitar-wrapper {
            border-color: rgba(255, 136, 0, 0.3);
        }

        .guitar-wrapper .instrument-brand {
            color: var(--guitar-primary);
            text-shadow: 0 0 10px var(--guitar-primary);
        }

        .guitar-fretboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
            background: linear-gradient(90deg, #3d2817 0%, #5c3d2a 50%, #3d2817 100%);
            padding: 15px 10px;
            border-radius: 8px;
            position: relative;
            min-width: 300px;
        }

        .guitar-fretboard::before {
            content: '';
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: #c9a55a;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(201, 165, 90, 0.5);
        }

        .guitar-string {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .guitar-fret {
            width: 40px;
            height: 35px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(201, 165, 90, 0.3);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: var(--text-dim);
            position: relative;
        }

        .guitar-fret::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(192, 192, 192, 0.3), 
                rgba(255, 255, 255, 0.6), 
                rgba(192, 192, 192, 0.3));
        }

        .guitar-fret:hover {
            background: rgba(255, 136, 0, 0.15);
            border-color: var(--guitar-primary);
        }

        .guitar-fret.active {
            background: radial-gradient(circle, var(--guitar-primary), #aa5500);
            border-color: var(--guitar-primary);
            box-shadow: 0 0 20px rgba(255, 136, 0, 0.6);
        }

        .guitar-fret.active::after {
            background: white;
            box-shadow: 0 0 10px white;
        }

        .guitar-chord-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .chord-name {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--guitar-primary);
            text-shadow: 0 0 15px var(--guitar-primary);
        }

        .chord-diagram {
            display: grid;
            grid-template-columns: repeat(6, 12px);
            gap: 4px;
        }

        .chord-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chord-dot.active {
            background: var(--guitar-primary);
            border-color: var(--guitar-primary);
            box-shadow: 0 0 8px var(--guitar-primary);
        }

        .strum-area {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.2));
            border-radius: 15px;
            border: 2px dashed rgba(255, 136, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .strum-area:hover {
            border-color: var(--guitar-primary);
            background: rgba(255, 136, 0, 0.1);
        }

        .strum-area:active {
            transform: scale(0.98);
        }

        .strum-hint {
            text-align: center;
            font-size: 0.7rem;
            letter-spacing: 3px;
            color: var(--guitar-primary);
            margin-bottom: 10px;
        }

        .strum-strings {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .strum-string {
            width: 3px;
            height: 50px;
            background: linear-gradient(180deg, #888, #ccc, #888);
            border-radius: 2px;
            transition: all 0.1s ease;
        }

        .strum-string.vibrate {
            animation: stringVibrate 0.3s ease;
        }

        @keyframes stringVibrate {
            0%, 100% { transform: translateX(0); }
            10% { transform: translateX(-3px); }
            20% { transform: translateX(3px); }
            30% { transform: translateX(-2px); }
            40% { transform: translateX(2px); }
            50% { transform: translateX(-1px); }
        }

        /* ============== DRUM MACHINE ============== */
        .drums-wrapper {
            border-color: rgba(255, 0, 170, 0.3);
        }

        .drums-wrapper .instrument-brand {
            color: var(--drums-primary);
            text-shadow: 0 0 10px var(--drums-primary);
        }

        .drum-machine {
            padding: 10px;
        }

        .drum-pad-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .drum-pad {
            width: clamp(60px, 15vw, 85px);
            height: clamp(60px, 15vw, 85px);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.08s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .drum-pad::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2), transparent);
            opacity: 0.5;
        }

        .drum-pad:hover {
            transform: scale(1.03);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .drum-pad:active,
        .drum-pad.active {
            transform: scale(0.95);
        }

        .drum-pad.active::after {
            content: '';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150%;
            height: 150%;
            background: radial-gradient(circle, currentColor, transparent 70%);
            animation: padPulse 0.3s ease-out;
        }

        @keyframes padPulse {
            0% { opacity: 0.8; transform: translate(-50%, -50%) scale(0.5); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .drum-pad-icon {
            font-size: 1.5rem;
        }

        .drum-pad-label {
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        .drum-pad-key {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.55rem;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 700;
        }

        /* Drum pad colors */
        .drum-pad.kick { background: linear-gradient(135deg, #ff0055, #aa0033); color: white; }
        .drum-pad.snare { background: linear-gradient(135deg, #ff8800, #aa5500); color: white; }
        .drum-pad.hihat { background: linear-gradient(135deg, #ffcc00, #aa8800); color: black; }
        .drum-pad.clap { background: linear-gradient(135deg, #00ccff, #0088aa); color: white; }
        .drum-pad.tom1 { background: linear-gradient(135deg, #ff00aa, #aa0066); color: white; }
        .drum-pad.tom2 { background: linear-gradient(135deg, #aa00ff, #6600aa); color: white; }
        .drum-pad.crash { background: linear-gradient(135deg, #00ff88, #00aa55); color: black; }
        .drum-pad.rim { background: linear-gradient(135deg, #888888, #555555); color: white; }
        .drum-pad.perc1 { background: linear-gradient(135deg, #ff5500, #aa3300); color: white; }
        .drum-pad.perc2 { background: linear-gradient(135deg, #0066ff, #0044aa); color: white; }
        .drum-pad.fx1 { background: linear-gradient(135deg, #ff0088, #aa0055); color: white; }
        .drum-pad.fx2 { background: linear-gradient(135deg, #00ffcc, #00aa88); color: black; }

        .drum-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .bpm-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .bpm-label {
            font-size: 0.6rem;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        .bpm-value {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--drums-primary);
            min-width: 35px;
            text-align: center;
        }

        #bpm-slider {
            width: 100px;
            accent-color: var(--drums-primary);
        }

        /* ============== BACK BUTTON ============== */
        .back-btn {
            position: absolute;
            bottom: 15px;
            left: 15px;
            padding: 10px 18px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: var(--text-dim);
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 2px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 125;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .back-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        }        /* ============== RESULTS SCREEN ============== */
        #results-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .results-container {
            text-align: center;
            padding: 30px 25px;
            max-width: 420px;
            width: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.92), rgba(0, 240, 255, 0.03));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(0, 240, 255, 0.2);
            border-radius: 24px;
            animation: resultsSlideIn 0.7s ease-out;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.9),
                0 0 60px rgba(0, 240, 255, 0.08);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }

        .results-container::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(0, 240, 255, 0.05), transparent, rgba(255, 0, 170, 0.05), transparent);
            animation: resultsRotate 15s linear infinite;
            z-index: -1;
        }

        @keyframes resultsRotate {
            to { transform: rotate(360deg); }
        }

        @keyframes resultsSlideIn {
            from { opacity: 0; transform: scale(0.85) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .results-header {
            margin-bottom: 20px;
        }

        .results-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            animation: resultsIconBounce 0.6s ease;
        }

        @keyframes resultsIconBounce {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        .results-title {
            font-size: 0.75rem;
            letter-spacing: 5px;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .results-song {
            font-size: clamp(1.2rem, 4vw, 1.6rem);
            font-weight: 900;
        }

        .results-grade-section {
            margin: 25px 0;
            position: relative;
        }

        .results-grade {
            font-size: clamp(6rem, 22vw, 10rem);
            font-weight: 900;
            line-height: 1;
            animation: gradeReveal 0.8s ease-out;
        }

        @keyframes gradeReveal {
            0% { opacity: 0; transform: scale(4) rotate(-15deg); }
            50% { transform: scale(1.1) rotate(3deg); }
            70% { transform: scale(0.95) rotate(-1deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        .results-grade.s {
            background: linear-gradient(135deg, #ff00ff, #00ffff, #ffff00, #ff00ff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradeReveal 0.8s ease-out, rainbowShift 2s linear infinite;
            filter: drop-shadow(0 0 50px rgba(255, 0, 255, 0.6));
        }

        @keyframes rainbowShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }

        .results-grade.a {
            color: var(--perfect);
            text-shadow: 0 0 50px var(--perfect), 0 0 100px var(--perfect);
        }

        .results-grade.b {
            color: var(--accent-gold);
            text-shadow: 0 0 50px var(--accent-gold);
        }

        .results-grade.c {
            color: #ff8800;
            text-shadow: 0 0 50px #ff8800;
        }

        .results-grade.d {
            color: #ff6644;
            text-shadow: 0 0 50px #ff6644;
        }

        .results-grade.f {
            color: var(--miss);
            text-shadow: 0 0 50px var(--miss);
        }

        .results-new-record {
            display: none;
            background: linear-gradient(135deg, var(--accent-gold), #ff8800);
            color: #000;
            padding: 12px 28px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(255, 204, 0, 0.4);
            animation: newRecordPulse 1s ease-in-out infinite;
        }

        .results-new-record.show {
            display: inline-block;
            animation: newRecordPop 0.5s ease-out, newRecordPulse 1s ease-in-out infinite 0.5s;
        }

        @keyframes newRecordPop {
            from { transform: scale(0) rotate(-10deg); opacity: 0; }
            to { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes newRecordPulse {
            0%, 100% { box-shadow: 0 8px 30px rgba(255, 204, 0, 0.4); }
            50% { box-shadow: 0 8px 50px rgba(255, 204, 0, 0.7), 0 0 80px rgba(255, 204, 0, 0.3); }
        }

        .results-stats {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .results-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }

        .results-stat-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .results-stat-row:last-child {
            border-bottom: none;
        }

        .results-stat-row.highlight {
            background: rgba(0, 240, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .results-stat-row.highlight .stat-value {
            color: var(--accent-gold);
            font-size: 1.2rem;
            text-shadow: 0 0 15px var(--accent-gold);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--accent);
        }

        .results-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ============== SONG SELECT MODAL ============== */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 500;
            animation: modalFadeIn 0.3s ease;
            padding: 20px;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, var(--bg-card), rgba(0, 240, 255, 0.02));
            border: 2px solid rgba(0, 240, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.8);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h2 {
            font-size: 1.2rem;
            font-weight: 800;
            letter-spacing: 2px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-dim);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 0, 100, 0.2);
            border-color: var(--miss);
            color: var(--miss);
        }

        .song-list {
            overflow-y: auto;
            flex: 1;
            padding-right: 10px;
        }

        .song-list::-webkit-scrollbar {
            width: 6px;
        }

        .song-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .song-list::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .song-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .song-item:hover {
            background: rgba(0, 240, 255, 0.08);
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .song-item:last-child {
            margin-bottom: 0;
        }

        .song-item-info h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .song-item-meta {
            display: flex;
            gap: 12px;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .song-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .song-item-score {
            text-align: right;
        }

        .song-item-score .highscore {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--accent-gold);
        }

        .song-item-score .grade {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.5rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .difficulty-badge.easy {
            background: linear-gradient(135deg, #00cc66, #00ff88);
            color: black;
        }

        .difficulty-badge.medium {
            background: linear-gradient(135deg, #ff9900, #ffcc00);
            color: black;
        }

        .difficulty-badge.hard {
            background: linear-gradient(135deg, #ff5500, #ff8844);
            color: white;
        }

        .difficulty-badge.expert {
            background: linear-gradient(135deg, #ff0055, #ff4488);
            color: white;
        }

        /* ============== RESPONSIVE ADJUSTMENTS ============== */
        @media (max-width: 600px) {
            .game-hud {
                padding: 10px 12px;
                flex-wrap: wrap;
            }

            .hud-left, .hud-right {
                flex: 1;
            }

            .hud-center {
                order: -1;
                width: 100%;
                margin-bottom: 8px;
            }

            .instrument-wrapper {
                padding: 12px 12px 18px;
            }

            .piano-keys {
                height: clamp(100px, 22vh, 150px);
            }

            .drum-pad-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }

            .drum-pad {
                width: clamp(50px, 20vw, 70px);
                height: clamp(50px, 20vw, 70px);
            }

            .target-note {
                width: 55px;
                height: 55px;
                font-size: 1.1rem;
            }

            .results-container {
                padding: 20px 18px;
            }

            .results-grade {
                font-size: clamp(5rem, 20vw, 8rem);
            }
        }

        @media (max-width: 400px) {
            .piano-key.white {
                width: 28px;
            }

            .piano-key.black {
                width: 18px;
            }

            .stats-row {
                flex-wrap: wrap;
            }

            .stat-box {
                flex: 1 1 45%;
            }

            .drum-pad-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* ============== UTILITY CLASSES ============== */
        .hidden {
            display: none !important;
        }

        .text-perfect { color: var(--perfect); }
        .text-good { color: var(--good); }
        .text-miss { color: var(--miss); }
        .text-accent { color: var(--accent); }
        .text-gold { color: var(--accent-gold); }

        /* ============== ANIMATIONS ============== */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.3s ease;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .glow {
            animation: glow 1s ease infinite;
        }
    </style>

    <script>
    // ============================================
    // RAPPERSTORE MELODY MASTER PRO - GAME ENGINE
    // ============================================

    // ============== CONFIGURATION ==============
    const CONFIG = {
        // Scoring
        perfectScore: 100,
        goodScore: 50,
        missScore: 0,
        perfectWindow: 200,  // ms
        goodWindow: 500,     // ms
        comboMultiplierMax: 10,

        // Timing
        countdownTime: 3,
        notePlayDuration: 400,
        sequenceDelay: 600,
        feedbackDuration: 600,

        // Audio
        defaultBPM: 120,
        masterVolume: 0.7
    };

    // ============== SOUND PACKS ==============
    const SOUND_PACKS = {
        piano: {
            grand: { name: 'Grand Piano', type: 'sampler', quality: 'high' },
            electric: { name: 'Electric Piano', type: 'synth', settings: { oscillator: { type: 'sine' }, envelope: { attack: 0.02, decay: 0.3, sustain: 0.4, release: 0.8 }}},
            synth: { name: 'Synth Keys', type: 'synth', settings: { oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }}},
            bright: { name: 'Bright Piano', type: 'synth', settings: { oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.4, sustain: 0.5, release: 1 }}}
        },
        guitar: {
            acoustic: { name: 'Acoustic', type: 'sampler' },
            electric: { name: 'Electric Clean', type: 'synth', settings: { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.4, release: 0.6 }}},
            nylon: { name: 'Nylon String', type: 'synth', settings: { oscillator: { type: 'sine' }, envelope: { attack: 0.02, decay: 0.5, sustain: 0.3, release: 0.8 }}}
        },
        drums: {
            trap: { name: 'Trap 808', type: 'sampler' },
            acoustic: { name: 'Acoustic Kit', type: 'sampler' },
            electronic: { name: 'Electronic', type: 'sampler' },
            lofi: { name: 'Lo-Fi', type: 'sampler' }
        }
    };

    // ============== NOTE FREQUENCIES ==============
    const NOTE_FREQUENCIES = {
        'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31,
        'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
        'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61,
        'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
        'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
        'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
        'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46,
        'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
        'C6': 1046.50
    };

    // ============== PIANO KEY MAPPINGS ==============
    const PIANO_WHITE_KEYS = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5'];
    const PIANO_BLACK_KEYS = ['C#4', 'D#4', 'F#4', 'G#4', 'A#4', 'C#5', 'D#5', 'F#5', 'G#5', 'A#5'];

    const KEYBOARD_TO_NOTE = {
        'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4', 'f': 'F4',
        't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4', 'u': 'A#4', 'j': 'B4',
        'k': 'C5', 'o': 'C#5', 'l': 'D5', 'p': 'D#5', ';': 'E5', "'": 'F5'
    };

    // ============== DRUM PAD CONFIG ==============
    const DRUM_PADS = [
        { id: 'kick', label: 'KICK', key: '1', class: 'kick', icon: 'ü•Å' },
        { id: 'snare', label: 'SNARE', key: '2', class: 'snare', icon: 'ü™ò' },
        { id: 'hihat', label: 'HI-HAT', key: '3', class: 'hihat', icon: 'üîî' },
        { id: 'clap', label: 'CLAP', key: '4', class: 'clap', icon: 'üëè' },
        { id: 'tom1', label: 'TOM 1', key: 'q', class: 'tom1', icon: 'ü•Å' },
        { id: 'tom2', label: 'TOM 2', key: 'w', class: 'tom2', icon: 'ü•Å' },
        { id: 'crash', label: 'CRASH', key: 'e', class: 'crash', icon: 'üí•' },
        { id: 'rim', label: 'RIM', key: 'r', class: 'rim', icon: 'üîò' },
        { id: 'perc1', label: 'PERC 1', key: 'a', class: 'perc1', icon: 'üéµ' },
        { id: 'perc2', label: 'PERC 2', key: 's', class: 'perc2', icon: 'üé∂' },
        { id: 'fx1', label: 'FX 1', key: 'd', class: 'fx1', icon: '‚ú®' },
        { id: 'fx2', label: 'FX 2', key: 'f', class: 'fx2', icon: 'üåü' }
    ];

    // ============== GUITAR CHORDS ==============
    const GUITAR_CHORDS = {
        'C': { notes: ['C3', 'E3', 'G3', 'C4', 'E4'], name: 'C Major' },
        'D': { notes: ['D3', 'A3', 'D4', 'F#4'], name: 'D Major' },
        'E': { notes: ['E2', 'B2', 'E3', 'G#3', 'B3', 'E4'], name: 'E Major' },
        'G': { notes: ['G2', 'B2', 'D3', 'G3', 'B3', 'G4'], name: 'G Major' },
        'A': { notes: ['A2', 'E3', 'A3', 'C#4', 'E4'], name: 'A Major' },
        'Am': { notes: ['A2', 'E3', 'A3', 'C4', 'E4'], name: 'A Minor' },
        'Em': { notes: ['E2', 'B2', 'E3', 'G3', 'B3', 'E4'], name: 'E Minor' },
        'Dm': { notes: ['D3', 'A3', 'D4', 'F4'], name: 'D Minor' },
        'F': { notes: ['F2', 'C3', 'F3', 'A3', 'C4', 'F4'], name: 'F Major' },
        'G7': { notes: ['G2', 'B2', 'D3', 'F3', 'G3', 'B3'], name: 'G7' }
    };

    // ============== SONGS DATABASE ==============
    const SONGS = {
        piano: [
            {
                id: 'twinkle',
                title: 'Twinkle Twinkle',
                difficulty: 'easy',
                bpm: 100,
                notes: ['C4', 'C4', 'G4', 'G4', 'A4', 'A4', 'G4', 'F4', 'F4', 'E4', 'E4', 'D4', 'D4', 'C4']
            },
            {
                id: 'mary',
                title: 'Mary Had a Lamb',
                difficulty: 'easy',
                bpm: 110,
                notes: ['E4', 'D4', 'C4', 'D4', 'E4', 'E4', 'E4', 'D4', 'D4', 'D4', 'E4', 'G4', 'G4']
            },
            {
                id: 'ode-joy',
                title: 'Ode to Joy',
                difficulty: 'medium',
                bpm: 120,
                notes: ['E4', 'E4', 'F4', 'G4', 'G4', 'F4', 'E4', 'D4', 'C4', 'C4', 'D4', 'E4', 'E4', 'D4', 'D4']
            },
            {
                id: 'fur-elise',
                title: 'F√ºr Elise',
                difficulty: 'medium',
                bpm: 125,
                notes: ['E5', 'D#5', 'E5', 'D#5', 'E5', 'B4', 'D5', 'C5', 'A4', 'C4', 'E4', 'A4', 'B4']
            },
            {
                id: 'moonlight',
                title: 'Moonlight Sonata',
                difficulty: 'hard',
                bpm: 60,
                notes: ['G#4', 'C#5', 'E5', 'G#4', 'C#5', 'E5', 'G#4', 'C#5', 'E5', 'G#4', 'C#5', 'E5']
            },
            {
                id: 'canon',
                title: 'Canon in D',
                difficulty: 'hard',
                bpm: 70,
                notes: ['F#5', 'E5', 'D5', 'C#5', 'B4', 'A4', 'B4', 'C#5', 'D5', 'C#5', 'B4', 'A4', 'G4', 'F#4', 'G4', 'A4']
            },
            {
                id: 'flight',
                title: 'Flight of Bumblebee',
                difficulty: 'expert',
                bpm: 160,
                notes: ['E5', 'D#5', 'D5', 'C#5', 'C5', 'B4', 'A#4', 'A4', 'G#4', 'A4', 'A#4', 'B4', 'C5', 'C#5', 'D5', 'D#5']
            }
        ],
        guitar: [
            {
                id: 'simple-chords',
                title: 'Simple Chords',
                difficulty: 'easy',
                bpm: 80,
                notes: ['C', 'G', 'Am', 'F']
            },
            {
                id: 'pop-progression',
                title: 'Pop Progression',
                difficulty: 'medium',
                bpm: 100,
                notes: ['G', 'D', 'Em', 'C', 'G', 'D', 'C']
            },
            {
                id: 'jazz-changes',
                title: 'Jazz Changes',
                difficulty: 'hard',
                bpm: 120,
                notes: ['Dm', 'G7', 'C', 'Am', 'Dm', 'G7', 'C']
            }
        ],
        drums: [
            {
                id: 'basic-beat',
                title: 'Basic Beat',
                difficulty: 'easy',
                bpm: 90,
                notes: ['kick', 'hihat', 'snare', 'hihat', 'kick', 'hihat', 'snare', 'hihat']
            },
            {
                id: 'trap-beat',
                title: 'Trap Beat',
                difficulty: 'medium',
                bpm: 140,
                notes: ['kick', 'hihat', 'hihat', 'snare', 'kick', 'kick', 'hihat', 'snare', 'hihat', 'hihat']
            },
            {
                id: 'complex-fill',
                title: 'Complex Fill',
                difficulty: 'hard',
                bpm: 120,
                notes: ['kick', 'snare', 'tom1', 'tom2', 'crash', 'kick', 'kick', 'snare', 'hihat', 'rim', 'tom1', 'crash']
            }
        ]
    };    // ============================================
    // AUDIO ENGINE - ROBUST VERSION (NO EXTERNAL SAMPLES)
    // Uses Tone.js synthesizers for guaranteed sound
    // ============================================

    const AudioEngine = {
        initialized: false,
        currentInstrument: 'piano',
        currentSoundPack: 'grand',
        masterVolume: null,
        instruments: {},
        effects: {},
        activeNotes: {},
        
        // Initialize the audio engine
        async init() {
            if (this.initialized) return true;
            
            try {
                updateLoadingStatus('Starting audio engine...');
                
                // Start Tone.js context
                await Tone.start();
                
                // Create master volume/limiter chain
                this.masterVolume = new Tone.Volume(-6).toDestination();
                
                // Add limiter to prevent clipping
                this.effects.limiter = new Tone.Limiter(-2).connect(this.masterVolume);
                
                // Add reverb for space
                this.effects.reverb = new Tone.Reverb({
                    decay: 2,
                    wet: 0.25
                }).connect(this.effects.limiter);
                
                await this.effects.reverb.ready;
                
                // Add delay
                this.effects.delay = new Tone.FeedbackDelay({
                    delayTime: 0.12,
                    feedback: 0.2,
                    wet: 0.15
                }).connect(this.effects.reverb);
                
                // Add chorus for richness
                this.effects.chorus = new Tone.Chorus({
                    frequency: 2,
                    delayTime: 3,
                    depth: 0.5,
                    wet: 0.2
                }).connect(this.effects.delay);
                
                await this.effects.chorus.start();
                
                // Initialize all synth-based instruments
                updateLoadingStatus('Creating piano...');
                await this.initPianoSynths();
                
                updateLoadingStatus('Creating guitar...');
                await this.initGuitarSynths();
                
                updateLoadingStatus('Creating drums...');
                await this.initDrumSynths();
                
                this.initialized = true;
                updateLoadingStatus('Audio engine ready!');
                
                console.log('‚úÖ Audio Engine initialized successfully');
                return true;
                
            } catch (error) {
                console.error('Audio init error:', error);
                updateLoadingStatus('Setting up basic audio...');
                
                // Even simpler fallback
                try {
                    await this.initBasicFallback();
                    this.initialized = true;
                    return true;
                } catch (e2) {
                    console.error('Fallback also failed:', e2);
                    updateLoadingStatus('Audio ready (basic mode)');
                    this.initialized = true;
                    return true;
                }
            }
        },

        // Initialize Piano Synthesizers
        async initPianoSynths() {
            // Grand Piano - Rich layered sound
            this.instruments.grandPiano = new Tone.PolySynth(Tone.Synth, {
                maxPolyphony: 16,
                voice: Tone.Synth,
                options: {
                    oscillator: {
                        type: 'fatsine',
                        count: 3,
                        spread: 20
                    },
                    envelope: {
                        attack: 0.01,
                        decay: 0.5,
                        sustain: 0.3,
                        release: 1.5
                    }
                }
            }).connect(this.effects.chorus);
            this.instruments.grandPiano.volume.value = -8;
            
            // Electric Piano - FM synthesis
            this.instruments.electricPiano = new Tone.PolySynth(Tone.FMSynth, {
                maxPolyphony: 12,
                voice: Tone.FMSynth,
                options: {
                    harmonicity: 3.01,
                    modulationIndex: 14,
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.8 },
                    modulation: { type: 'square' },
                    modulationEnvelope: { attack: 0.002, decay: 0.2, sustain: 0, release: 0.5 }
                }
            }).connect(this.effects.chorus);
            this.instruments.electricPiano.volume.value = -10;
            
            // Synth Keys - Classic synth
            this.instruments.synthKeys = new Tone.PolySynth(Tone.Synth, {
                maxPolyphony: 12,
                voice: Tone.Synth,
                options: {
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.01, decay: 0.3, sustain: 0.5, release: 0.4 },
                    filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.5 }
                }
            }).connect(this.effects.chorus);
            this.instruments.synthKeys.volume.value = -12;
            
            // Bright Piano - Bell-like
            this.instruments.brightPiano = new Tone.PolySynth(Tone.Synth, {
                maxPolyphony: 12,
                voice: Tone.Synth,
                options: {
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.4, sustain: 0.2, release: 1.2 }
                }
            }).connect(this.effects.chorus);
            this.instruments.brightPiano.volume.value = -6;
        },

        // Initialize Guitar Synthesizers
        async initGuitarSynths() {
            // Acoustic Guitar - Pluck synth
            this.instruments.acousticGuitar = new Tone.PolySynth(Tone.PluckSynth, {
                maxPolyphony: 8,
                voice: Tone.PluckSynth,
                options: {
                    attackNoise: 1.5,
                    dampening: 3500,
                    resonance: 0.97
                }
            }).connect(this.effects.delay);
            this.instruments.acousticGuitar.volume.value = -6;
            
            // Electric Guitar - Distorted
            this.instruments.electricGuitar = new Tone.PolySynth(Tone.MonoSynth, {
                maxPolyphony: 6,
                voice: Tone.MonoSynth,
                options: {
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.01, decay: 0.3, sustain: 0.5, release: 0.8 },
                    filterEnvelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.5 }
                }
            }).connect(this.effects.delay);
            this.instruments.electricGuitar.volume.value = -10;
            
            // Nylon Guitar - Soft mellow
            this.instruments.nylonGuitar = new Tone.PolySynth(Tone.Synth, {
                maxPolyphony: 8,
                voice: Tone.Synth,
                options: {
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.03, decay: 0.6, sustain: 0.2, release: 1.0 }
                }
            }).connect(this.effects.delay);
            this.instruments.nylonGuitar.volume.value = -8;
        },

        // Initialize Drum Synthesizers
        async initDrumSynths() {
            // 808 Kick
            this.instruments.kick = new Tone.MembraneSynth({
                pitchDecay: 0.08,
                octaves: 6,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.5, sustain: 0, release: 0.5 }
            }).connect(this.effects.limiter);
            this.instruments.kick.volume.value = -4;
            
            // Snare
            this.instruments.snare = new Tone.NoiseSynth({
                noise: { type: 'white', playbackRate: 3 },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.15 }
            }).connect(this.effects.limiter);
            this.instruments.snare.volume.value = -8;
            
            // Snare body (layered with noise)
            this.instruments.snareBody = new Tone.MembraneSynth({
                pitchDecay: 0.01,
                octaves: 4,
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
            }).connect(this.effects.limiter);
            this.instruments.snareBody.volume.value = -12;
            
            // Hi-Hat Closed
            this.instruments.hihat = new Tone.MetalSynth({
                frequency: 350,
                envelope: { attack: 0.001, decay: 0.08, release: 0.01 },
                harmonicity: 5.1,
                modulationIndex: 40,
                resonance: 3500,
                octaves: 1
            }).connect(this.effects.limiter);
            this.instruments.hihat.volume.value = -16;
            
            // Clap
            this.instruments.clap = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.15, sustain: 0, release: 0.1 }
            }).connect(this.effects.reverb);
            this.instruments.clap.volume.value = -10;
            
            // Tom High
            this.instruments.tomHigh = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 3,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 }
            }).connect(this.effects.limiter);
            this.instruments.tomHigh.volume.value = -8;
            
            // Tom Low
            this.instruments.tomLow = new Tone.MembraneSynth({
                pitchDecay: 0.06,
                octaves: 4,
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.35, sustain: 0, release: 0.35 }
            }).connect(this.effects.limiter);
            this.instruments.tomLow.volume.value = -8;
            
            // Crash
            this.instruments.crash = new Tone.MetalSynth({
                frequency: 280,
                envelope: { attack: 0.001, decay: 1.2, release: 0.8 },
                harmonicity: 3.1,
                modulationIndex: 20,
                resonance: 3000,
                octaves: 1.5
            }).connect(this.effects.reverb);
            this.instruments.crash.volume.value = -14;
            
            // Rim
            this.instruments.rim = new Tone.MembraneSynth({
                pitchDecay: 0.008,
                octaves: 2,
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.02 }
            }).connect(this.effects.limiter);
            this.instruments.rim.volume.value = -10;
            
            // Percussion (shaker-like)
            this.instruments.perc = new Tone.NoiseSynth({
                noise: { type: 'brown' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.05 }
            }).connect(this.effects.limiter);
            this.instruments.perc.volume.value = -14;
            
            // FX - Laser/zap
            this.instruments.fx = new Tone.Synth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.1 }
            }).connect(this.effects.delay);
            this.instruments.fx.volume.value = -12;
        },

        // Basic fallback if everything fails
        async initBasicFallback() {
            this.masterVolume = new Tone.Volume(-6).toDestination();
            this.effects.limiter = new Tone.Limiter(-3).connect(this.masterVolume);
            
            // One simple synth for everything
            this.instruments.basicSynth = new Tone.PolySynth(Tone.Synth).connect(this.effects.limiter);
            this.instruments.basicSynth.volume.value = -8;
            
            // Basic drum sounds
            this.instruments.kick = new Tone.MembraneSynth().connect(this.effects.limiter);
            this.instruments.snare = new Tone.NoiseSynth().connect(this.effects.limiter);
            this.instruments.hihat = new Tone.MetalSynth().connect(this.effects.limiter);
            this.instruments.hihat.volume.value = -20;
        },

        // Start audio context (required for browsers)
        async startContext() {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log('Audio context started');
            }
        },

        // ============== PLAY FUNCTIONS ==============

        // Get the active piano instrument based on sound pack
        getActivePianoInstrument() {
            switch (this.currentSoundPack) {
                case 'grand': return this.instruments.grandPiano;
                case 'electric': return this.instruments.electricPiano;
                case 'synth': return this.instruments.synthKeys;
                case 'bright': return this.instruments.brightPiano;
                default: return this.instruments.grandPiano || this.instruments.basicSynth;
            }
        },

        // Get the active guitar instrument
        getActiveGuitarInstrument() {
            switch (this.currentSoundPack) {
                case 'acoustic': return this.instruments.acousticGuitar;
                case 'electric': return this.instruments.electricGuitar;
                case 'nylon': return this.instruments.nylonGuitar;
                default: return this.instruments.acousticGuitar || this.instruments.basicSynth;
            }
        },

        // Play a piano note
        playPiano(note, duration = '8n', velocity = 0.8) {
            this.startContext();
            
            try {
                const instrument = this.getActivePianoInstrument();
                if (instrument) {
                    instrument.triggerAttackRelease(note, duration, Tone.now(), velocity);
                }
            } catch (e) {
                console.warn('Piano play error:', e);
            }
            
            this.triggerVisualizer();
        },

        // Start a sustained piano note
        startPianoNote(note, velocity = 0.8) {
            this.startContext();
            
            if (this.activeNotes[note]) return;
            
            try {
                const instrument = this.getActivePianoInstrument();
                if (instrument) {
                    instrument.triggerAttack(note, Tone.now(), velocity);
                    this.activeNotes[note] = true;
                }
            } catch (e) {
                console.warn('Piano start error:', e);
            }
            
            this.triggerVisualizer();
        },

        // Stop a sustained piano note
        stopPianoNote(note) {
            if (!this.activeNotes[note]) return;
            
            try {
                const instrument = this.getActivePianoInstrument();
                if (instrument) {
                    instrument.triggerRelease(note, Tone.now());
                }
            } catch (e) {
                console.warn('Piano stop error:', e);
            }
            
            delete this.activeNotes[note];
        },

        // Play guitar note
        playGuitar(note, duration = '4n', velocity = 0.8) {
            this.startContext();
            
            try {
                const instrument = this.getActiveGuitarInstrument();
                if (instrument) {
                    instrument.triggerAttackRelease(note, duration, Tone.now(), velocity);
                }
            } catch (e) {
                console.warn('Guitar play error:', e);
            }
            
            this.triggerVisualizer();
        },

        // Strum a guitar chord
        strumChord(chordName, direction = 'down', duration = '2n') {
            this.startContext();
            
            const chord = GUITAR_CHORDS[chordName];
            if (!chord) {
                console.warn('Unknown chord:', chordName);
                return;
            }
            
            const instrument = this.getActiveGuitarInstrument();
            if (!instrument) return;
            
            const notes = direction === 'down' ? chord.notes : [...chord.notes].reverse();
            const strumDelay = 0.025; // 25ms between strings for realistic strum
            
            notes.forEach((note, index) => {
                const time = Tone.now() + (index * strumDelay);
                const vel = 0.6 + (Math.random() * 0.2); // Slight velocity variation
                
                try {
                    instrument.triggerAttackRelease(note, duration, time, vel);
                } catch (e) {
                    console.warn('Strum note error:', e);
                }
            });
            
            this.triggerVisualizer();
            this.animateStrings();
        },

        // Animate guitar strings
        animateStrings() {
            const strings = document.querySelectorAll('.strum-string');
            strings.forEach((string, i) => {
                setTimeout(() => {
                    string.classList.add('vibrate');
                    setTimeout(() => string.classList.remove('vibrate'), 300);
                }, i * 25);
            });
        },

        // Play drum sound
        playDrum(drumId, velocity = 0.9) {
            this.startContext();
            
            try {
                switch (drumId) {
                    case 'kick':
                        this.instruments.kick?.triggerAttackRelease('C1', '8n', Tone.now(), velocity);
                        break;
                        
                    case 'snare':
                        this.instruments.snare?.triggerAttackRelease('16n', Tone.now(), velocity);
                        this.instruments.snareBody?.triggerAttackRelease('E2', '16n', Tone.now(), velocity * 0.6);
                        break;
                        
                    case 'hihat':
                        this.instruments.hihat?.triggerAttackRelease('32n', Tone.now(), velocity * 0.7);
                        break;
                        
                    case 'clap':
                        this.instruments.clap?.triggerAttackRelease('8n', Tone.now(), velocity);
                        break;
                        
                    case 'tom1':
                        this.instruments.tomHigh?.triggerAttackRelease('G3', '8n', Tone.now(), velocity);
                        break;
                        
                    case 'tom2':
                        this.instruments.tomLow?.triggerAttackRelease('D3', '8n', Tone.now(), velocity);
                        break;
                        
                    case 'crash':
                        this.instruments.crash?.triggerAttackRelease('16n', Tone.now(), velocity);
                        break;
                        
                    case 'rim':
                        this.instruments.rim?.triggerAttackRelease('G4', '32n', Tone.now(), velocity);
                        break;
                        
                    case 'perc1':
                        this.instruments.perc?.triggerAttackRelease('16n', Tone.now(), velocity);
                        break;
                        
                    case 'perc2':
                        this.instruments.perc?.triggerAttackRelease('8n', Tone.now(), velocity * 0.8);
                        break;
                        
                    case 'fx1':
                        this.instruments.fx?.triggerAttackRelease('C6', '16n', Tone.now(), velocity);
                        break;
                        
                    case 'fx2':
                        this.instruments.fx?.triggerAttackRelease('G5', '8n', Tone.now(), velocity);
                        break;
                        
                    default:
                        // Generic drum hit
                        this.instruments.kick?.triggerAttackRelease('C2', '8n', Tone.now(), velocity);
                }
            } catch (e) {
                console.warn('Drum play error:', e);
            }
            
            this.triggerVisualizer();
        },

        // Generic play function based on current instrument
        playNote(note, duration = '8n', velocity = 0.8) {
            switch (this.currentInstrument) {
                case 'piano':
                    this.playPiano(note, duration, velocity);
                    break;
                case 'guitar':
                    if (GUITAR_CHORDS[note]) {
                        this.strumChord(note, 'down', duration);
                    } else {
                        this.playGuitar(note, duration, velocity);
                    }
                    break;
                case 'drums':
                    this.playDrum(note, velocity);
                    break;
            }
        },

        // Start note (for held notes)
        startNote(note, velocity = 0.8) {
            switch (this.currentInstrument) {
                case 'piano':
                    this.startPianoNote(note, velocity);
                    break;
                case 'guitar':
                    this.playGuitar(note, '2n', velocity);
                    break;
                case 'drums':
                    this.playDrum(note, velocity);
                    break;
            }
        },

        // Stop note
        stopNote(note) {
            switch (this.currentInstrument) {
                case 'piano':
                    this.stopPianoNote(note);
                    break;
                // Guitar and drums don't need note-off
            }
        },

        // Set current instrument
        setInstrument(instrument) {
            this.currentInstrument = instrument;
            
            // Set default sound pack for the instrument
            const defaultPacks = {
                piano: 'grand',
                guitar: 'acoustic',
                drums: 'trap'
            };
            
            this.currentSoundPack = defaultPacks[instrument] || 'grand';
        },

        // Set sound pack
        setSoundPack(pack) {
            this.currentSoundPack = pack;
        },

        // Trigger visualizer animation
        triggerVisualizer() {
            if (window.Visualizer && Visualizer.trigger) {
                Visualizer.trigger();
            }
        },

        // Set master volume (0 to 1)
        setVolume(value) {
            if (this.masterVolume) {
                // Convert 0-1 to dB (-60 to 0)
                const db = value > 0 ? 20 * Math.log10(value) : -60;
                this.masterVolume.volume.value = Math.max(-60, Math.min(0, db));
            }
        },

        // Cleanup
        dispose() {
            // Stop all active notes
            Object.keys(this.activeNotes).forEach(note => {
                this.stopNote(note);
            });
            
            // Dispose instruments
            Object.values(this.instruments).forEach(inst => {
                try {
                    if (inst && inst.dispose) inst.dispose();
                } catch (e) {}
            });
            
            // Dispose effects
            Object.values(this.effects).forEach(effect => {
                try {
                    if (effect && effect.dispose) effect.dispose();
                } catch (e) {}
            });
        }
    };

    // ============================================
    // AUDIO VISUALIZER
    // ============================================

    const Visualizer = {
        bars: [],
        isActive: false,
        animationId: null,
        container: null,
        
        init() {
            this.container = document.getElementById('audio-visualizer');
            if (!this.container) return;
            
            this.container.innerHTML = '';
            this.bars = [];
            
            const barCount = 50;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'viz-bar';
                bar.style.height = '3px';
                this.container.appendChild(bar);
                this.bars.push({
                    element: bar,
                    velocity: 0,
                    height: 3
                });
            }
        },
        
        trigger() {
            if (!this.bars.length) return;
            
            // Trigger random bars to animate
            const numBars = Math.floor(Math.random() * 20) + 8;
            for (let i = 0; i < numBars; i++) {
                const idx = Math.floor(Math.random() * this.bars.length);
                this.bars[idx].velocity = Math.random() * 60 + 25;
            }
            
            if (!this.isActive) {
                this.isActive = true;
                this.animate();
            }
        },
        
        animate() {
            let hasActivity = false;
            
            this.bars.forEach(bar => {
                if (bar.velocity > 0) {
                    bar.height = Math.min(100, bar.height + bar.velocity * 0.3);
                    bar.velocity *= 0.88;
                    if (bar.velocity < 0.5) bar.velocity = 0;
                    hasActivity = true;
                }
                
                // Decay
                bar.height *= 0.94;
                bar.height = Math.max(3, bar.height);
                
                bar.element.style.height = bar.height + 'px';
                
                if (bar.height > 5) hasActivity = true;
            });
            
            if (hasActivity) {
                this.animationId = requestAnimationFrame(() => this.animate());
            } else {
                this.isActive = false;
            }
        },
        
        stop() {
            this.isActive = false;
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
            }
        }
    };

    // ============================================
    // HELPER FUNCTION
    // ============================================

    function updateLoadingStatus(text) {
        const statusEl = document.getElementById('loading-status');
        if (statusEl) {
            statusEl.textContent = text;
        }
        console.log('[Loading]', text);
    }    // ============================================
    // GAME STATE MANAGEMENT
    // ============================================

    const GameState = {
        // Current state
        screen: 'menu',
        instrument: 'piano',
        soundPack: 'grand',
        mode: 'freeplay',
        
        // Game session
        isPlaying: false,
        isPaused: false,
        isListening: true,
        currentSong: null,
        
        // Progress
        currentNoteIndex: 0,
        targetNotes: [],
        playedNotes: [],
        sequenceLength: 4,
        
        // Scoring
        score: 0,
        combo: 0,
        maxCombo: 0,
        multiplier: 1,
        perfectCount: 0,
        goodCount: 0,
        missCount: 0,
        totalNotes: 0,
        
        // Timing
        startTime: 0,
        roundStartTime: 0,
        noteTimings: [],
        
        // Reset game state
        reset() {
            this.isPlaying = false;
            this.isPaused = false;
            this.isListening = true;
            this.currentNoteIndex = 0;
            this.targetNotes = [];
            this.playedNotes = [];
            this.score = 0;
            this.combo = 0;
            this.maxCombo = 0;
            this.multiplier = 1;
            this.perfectCount = 0;
            this.goodCount = 0;
            this.missCount = 0;
            this.totalNotes = 0;
            this.startTime = 0;
            this.roundStartTime = 0;
            this.noteTimings = [];
        },
        
        // Calculate accuracy
        getAccuracy() {
            const total = this.perfectCount + this.goodCount + this.missCount;
            if (total === 0) return 100;
            return Math.round(((this.perfectCount + this.goodCount * 0.5) / total) * 100);
        },
        
        // Calculate grade
        getGrade() {
            const accuracy = this.getAccuracy();
            if (accuracy >= 95 && this.missCount === 0) return 'S';
            if (accuracy >= 90) return 'A';
            if (accuracy >= 75) return 'B';
            if (accuracy >= 60) return 'C';
            if (accuracy >= 40) return 'D';
            return 'F';
        },
        
        // Add score with multiplier
        addScore(baseScore, isPerfect = false) {
            const multipliedScore = Math.round(baseScore * this.multiplier);
            this.score += multipliedScore;
            
            if (isPerfect) {
                this.perfectCount++;
            } else {
                this.goodCount++;
            }
            
            this.combo++;
            this.maxCombo = Math.max(this.maxCombo, this.combo);
            this.multiplier = Math.min(CONFIG.comboMultiplierMax, 1 + Math.floor(this.combo / 5) * 0.5);
            
            return multipliedScore;
        },
        
        // Handle miss
        handleMiss() {
            this.missCount++;
            this.combo = 0;
            this.multiplier = 1;
        }
    };

    // ============================================
    // HIGH SCORES MANAGER
    // ============================================

    const HighScores = {
        storageKey: 'rapperstore_melodymaster_pro_v2',
        
        getAll() {
            try {
                return JSON.parse(localStorage.getItem(this.storageKey)) || {};
            } catch (e) {
                return {};
            }
        },
        
        get(songId) {
            const all = this.getAll();
            return all[songId] || { score: 0, accuracy: 0, grade: '-', plays: 0 };
        },
        
        save(songId, score, accuracy, grade) {
            const all = this.getAll();
            const current = all[songId] || { score: 0, accuracy: 0, grade: '-', plays: 0 };
            
            let isNewRecord = false;
            
            if (score > current.score) {
                current.score = score;
                current.grade = grade;
                isNewRecord = true;
            }
            
            if (accuracy > current.accuracy) {
                current.accuracy = accuracy;
            }
            
            current.plays = (current.plays || 0) + 1;
            current.lastPlayed = Date.now();
            
            all[songId] = current;
            
            try {
                localStorage.setItem(this.storageKey, JSON.stringify(all));
            } catch (e) {
                console.warn('Failed to save high score');
            }
            
            return isNewRecord;
        },
        
        getBestScore() {
            const all = this.getAll();
            return Math.max(0, ...Object.values(all).map(x => x.score || 0));
        },
        
        getBestAccuracy() {
            const all = this.getAll();
            const accuracies = Object.values(all).map(x => x.accuracy || 0).filter(x => x > 0);
            return accuracies.length > 0 ? Math.max(...accuracies) : 0;
        },
        
        getTotalPlays() {
            const all = this.getAll();
            return Object.values(all).reduce((sum, x) => sum + (x.plays || 0), 0);
        }
    };

    // ============================================
    // DOM REFERENCES
    // ============================================

    const DOM = {
        // Screens
        screens: {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            results: document.getElementById('results-screen')
        },
        
        // Loading
        loading: document.getElementById('loading'),
        loadingStatus: document.getElementById('loading-status'),
        
        // Menu elements
        statBestScore: document.getElementById('stat-best-score'),
        statAccuracy: document.getElementById('stat-accuracy'),
        statSongs: document.getElementById('stat-songs'),
        soundpackSection: document.getElementById('soundpack-section'),
        soundpackGrid: document.getElementById('soundpack-grid'),
        startBtn: document.getElementById('start-btn'),
        
        // Game elements
        gameTitle: document.getElementById('game-title'),
        gameModeLabel: document.getElementById('game-mode-label'),
        scoreValue: document.getElementById('score-value'),
        comboValue: document.getElementById('combo-value'),
        comboFill: document.getElementById('combo-fill'),
        accuracyValue: document.getElementById('accuracy-value'),
        streakValue: document.getElementById('streak-value'),
        gameProgressBar: document.getElementById('game-progress-bar'),
        gameProgressText: document.getElementById('game-progress-text'),
        targetArea: document.getElementById('target-area'),
        targetInstruction: document.getElementById('target-instruction'),
        targetNotesDisplay: document.getElementById('target-notes-display'),
        listenIndicator: document.getElementById('listen-indicator'),
        feedbackPopup: document.getElementById('feedback-popup'),
        countdownDisplay: document.getElementById('countdown-display'),
        screenFlash: document.getElementById('screen-flash'),
        
        // Instrument containers
        pianoContainer: document.getElementById('piano-container'),
        pianoKeys: document.getElementById('piano-keys'),
        guitarContainer: document.getElementById('guitar-container'),
        guitarFretboard: document.getElementById('guitar-fretboard'),
        guitarChordName: document.getElementById('guitar-chord-name'),
        chordDiagram: document.getElementById('chord-diagram'),
        strumArea: document.getElementById('strum-area'),
        drumsContainer: document.getElementById('drums-container'),
        drumPadGrid: document.getElementById('drum-pad-grid'),
        bpmSlider: document.getElementById('bpm-slider'),
        bpmValue: document.getElementById('bpm-value'),
        
        // Modal
        songModal: document.getElementById('song-modal'),
        songList: document.getElementById('song-list'),
        modalClose: document.getElementById('modal-close'),
        
        // Buttons
        gameBackBtn: document.getElementById('game-back-btn'),
        resultsRetryBtn: document.getElementById('results-retry-btn'),
        resultsMenuBtn: document.getElementById('results-menu-btn'),
        
        // Results
        resultsIcon: document.getElementById('results-icon'),
        resultsSongName: document.getElementById('results-song-name'),
        resultsGrade: document.getElementById('results-grade'),
        resultsNewRecord: document.getElementById('results-new-record'),
        resultsScore: document.getElementById('results-score'),
        resultsAccuracy: document.getElementById('results-accuracy'),
        resultsPerfect: document.getElementById('results-perfect'),
        resultsGood: document.getElementById('results-good'),
        resultsMissed: document.getElementById('results-missed'),
        resultsMaxCombo: document.getElementById('results-max-combo')
    };

    // ============================================
    // UI CONTROLLER
    // ============================================

    const UI = {
        // Show a screen
        showScreen(screenName) {
            Object.values(DOM.screens).forEach(screen => {
                screen.classList.remove('active');
            });
            
            if (DOM.screens[screenName]) {
                DOM.screens[screenName].classList.add('active');
                GameState.screen = screenName;
            }
        },
        
        // Update menu stats
        updateMenuStats() {
            DOM.statBestScore.textContent = HighScores.getBestScore().toLocaleString();
            const acc = HighScores.getBestAccuracy();
            DOM.statAccuracy.textContent = acc > 0 ? acc + '%' : '-%';
            DOM.statSongs.textContent = HighScores.getTotalPlays();
        },
        
        // Update sound pack buttons
        updateSoundPacks() {
            const packs = SOUND_PACKS[GameState.instrument];
            if (!packs) return;
            
            DOM.soundpackGrid.innerHTML = '';
            
            Object.entries(packs).forEach(([key, pack]) => {
                const btn = document.createElement('button');
                btn.className = 'soundpack-btn' + (key === GameState.soundPack ? ' selected' : '');
                btn.textContent = pack.name;
                btn.dataset.pack = key;
                
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.soundpack-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    GameState.soundPack = key;
                    AudioEngine.setSoundPack(key);
                });
                
                DOM.soundpackGrid.appendChild(btn);
            });
        },
        
        // Update game HUD
        updateHUD() {
            DOM.scoreValue.textContent = GameState.score.toLocaleString();
            DOM.comboValue.textContent = GameState.combo + 'x';
            DOM.accuracyValue.textContent = GameState.getAccuracy() + '%';
            DOM.streakValue.textContent = GameState.combo;
            
            // Combo bar fill
            const comboProgress = Math.min(100, (GameState.combo % 5) * 20);
            DOM.comboFill.style.width = comboProgress + '%';
            
            // Fire effect for high combo
            DOM.comboValue.classList.toggle('fire', GameState.combo >= 10);
        },
        
        // Update progress bar
        updateProgress(current, total) {
            const percent = total > 0 ? (current / total) * 100 : 0;
            DOM.gameProgressBar.style.setProperty('--progress', percent + '%');
            DOM.gameProgressBar.querySelector('::after')?.style.setProperty('width', percent + '%');
            
            // Workaround for pseudo-element
            DOM.gameProgressBar.innerHTML = `<div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-secondary), var(--accent-tertiary)); border-radius: 3px; transition: width 0.3s ease; box-shadow: 0 0 10px var(--accent);"></div>`;
            
            DOM.gameProgressText.textContent = `${current} / ${total}`;
        },
        
        // Show feedback popup
        showFeedback(text, type) {
            DOM.feedbackPopup.textContent = text;
            DOM.feedbackPopup.className = 'feedback-popup ' + type;
            
            // Force reflow for animation restart
            void DOM.feedbackPopup.offsetWidth;
            DOM.feedbackPopup.classList.add(type);
        },
        
        // Screen flash effect
        screenFlash(type) {
            DOM.screenFlash.className = 'screen-flash';
            void DOM.screenFlash.offsetWidth;
            DOM.screenFlash.classList.add(type);
        },
        
        // Bump score animation
        bumpScore() {
            DOM.scoreValue.classList.add('bump');
            setTimeout(() => DOM.scoreValue.classList.remove('bump'), 200);
        },
        
        // Show target notes
        showTargetNotes(notes) {
            DOM.targetNotesDisplay.innerHTML = '';
            
            notes.forEach((note, index) => {
                const noteEl = document.createElement('div');
                noteEl.className = 'target-note';
                noteEl.id = `target-note-${index}`;
                
                // Format note display
                let displayText = note;
                if (GameState.instrument === 'piano' || GameState.instrument === 'guitar') {
                    displayText = note.replace(/[0-9]/g, '');
                } else if (GameState.instrument === 'drums') {
                    displayText = note.toUpperCase().substring(0, 3);
                }
                
                noteEl.textContent = displayText;
                DOM.targetNotesDisplay.appendChild(noteEl);
            });
        },
        
        // Mark target note as correct
        markNoteCorrect(index) {
            const noteEl = document.getElementById(`target-note-${index}`);
            if (noteEl) {
                noteEl.classList.add('correct');
            }
        },
        
        // Mark target note as wrong
        markNoteWrong(index) {
            const noteEl = document.getElementById(`target-note-${index}`);
            if (noteEl) {
                noteEl.classList.add('wrong');
            }
        },
        
        // Show listen indicator
        showListenIndicator(show) {
            DOM.listenIndicator.classList.toggle('active', show);
        },
        
        // Set instruction text
        setInstruction(text) {
            DOM.targetInstruction.textContent = text;
        },
        
        // Show countdown
        async showCountdown() {
            return new Promise(resolve => {
                let count = CONFIG.countdownTime;
                
                const tick = () => {
                    if (count > 0) {
                        DOM.countdownDisplay.textContent = count;
                        DOM.countdownDisplay.classList.remove('show');
                        void DOM.countdownDisplay.offsetWidth;
                        DOM.countdownDisplay.classList.add('show');
                        count--;
                        setTimeout(tick, 900);
                    } else {
                        DOM.countdownDisplay.textContent = 'GO!';
                        DOM.countdownDisplay.classList.remove('show');
                        void DOM.countdownDisplay.offsetWidth;
                        DOM.countdownDisplay.classList.add('show');
                        
                        setTimeout(() => {
                            DOM.countdownDisplay.classList.remove('show');
                            resolve();
                        }, 800);
                    }
                };
                
                tick();
            });
        },
        
        // Show results screen
        showResults(isNewRecord) {
            DOM.resultsSongName.textContent = GameState.currentSong?.title || 'Free Play';
            
            const grade = GameState.getGrade();
            DOM.resultsGrade.textContent = grade;
            DOM.resultsGrade.className = 'results-grade ' + grade.toLowerCase();
            
            DOM.resultsScore.textContent = GameState.score.toLocaleString();
            DOM.resultsAccuracy.textContent = GameState.getAccuracy() + '%';
            DOM.resultsPerfect.textContent = GameState.perfectCount;
            DOM.resultsGood.textContent = GameState.goodCount;
            DOM.resultsMissed.textContent = GameState.missCount;
            DOM.resultsMaxCombo.textContent = GameState.maxCombo + 'x';
            
            DOM.resultsNewRecord.classList.toggle('show', isNewRecord);
            
            // Set icon based on grade
            const icons = { S: 'üèÜ', A: 'üåü', B: '‚ú®', C: 'üëç', D: 'üí™', F: 'üò¢' };
            DOM.resultsIcon.textContent = icons[grade] || 'üéµ';
            
            this.showScreen('results');
        },
        
        // Populate song list modal
        populateSongList() {
            const songs = SONGS[GameState.instrument] || [];
            DOM.songList.innerHTML = '';
            
            if (songs.length === 0) {
                DOM.songList.innerHTML = '<p style="text-align: center; color: var(--text-dim); padding: 20px;">No songs available for this instrument yet.</p>';
                return;
            }
            
            songs.forEach(song => {
                const highscore = HighScores.get(song.id);
                
                const item = document.createElement('div');
                item.className = 'song-item';
                item.innerHTML = `
                    <div class="song-item-info">
                        <h3>${song.title}</h3>
                        <div class="song-item-meta">
                            <span>üéµ ${song.notes.length} notes</span>
                            <span>üéπ ${song.bpm} BPM</span>
                            <span class="difficulty-badge ${song.difficulty}">${song.difficulty.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="song-item-score">
                        ${highscore.score > 0 ? `
                            <div class="highscore">üëë ${highscore.score.toLocaleString()}</div>
                            <div class="grade">Grade: ${highscore.grade}</div>
                        ` : '<div class="grade" style="color: var(--text-dim);">Not played</div>'}
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    GameState.currentSong = song;
                    this.hideSongModal();
                    GameController.startGame();
                });
                
                DOM.songList.appendChild(item);
            });
        },
        
        // Show song modal
        showSongModal() {
            this.populateSongList();
            DOM.songModal.style.display = 'flex';
        },
        
        // Hide song modal
        hideSongModal() {
            DOM.songModal.style.display = 'none';
        }
    };

    // ============================================
    // INSTRUMENT BUILDERS
    // ============================================

    const InstrumentBuilder = {
        // Build Piano
        buildPiano() {
            DOM.pianoKeys.innerHTML = '';
            
            const blackKeyOffsets = {
                'C#': 0, 'D#': 1, 'F#': 3, 'G#': 4, 'A#': 5
            };
            
            // Create white keys
            PIANO_WHITE_KEYS.forEach((note, index) => {
                const key = document.createElement('div');
                key.className = 'piano-key white';
                key.dataset.note = note;
                
                const label = document.createElement('span');
                label.className = 'key-label';
                label.textContent = note.replace(/[0-9]/g, '');
                key.appendChild(label);
                
                // Event listeners
                key.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.onPianoKeyDown(note, key);
                });
                
                key.addEventListener('mouseup', () => this.onPianoKeyUp(note, key));
                key.addEventListener('mouseleave', () => this.onPianoKeyUp(note, key));
                
                key.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.onPianoKeyDown(note, key);
                }, { passive: false });
                
                key.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.onPianoKeyUp(note, key);
                }, { passive: false });
                
                DOM.pianoKeys.appendChild(key);
            });
            
            // Calculate key width after DOM update
            requestAnimationFrame(() => {
                const whiteKeyWidth = DOM.pianoKeys.querySelector('.white')?.offsetWidth || 45;
                
                // Create black keys
                PIANO_BLACK_KEYS.forEach(note => {
                    const key = document.createElement('div');
                    key.className = 'piano-key black';
                    key.dataset.note = note;
                    
                    const label = document.createElement('span');
                    label.className = 'key-label';
                    label.textContent = note.replace(/[0-9]/g, '');
                    key.appendChild(label);
                    
                    // Calculate position
                    const noteName = note.replace(/[0-9]/g, '');
                    const octave = parseInt(note.match(/[0-9]/)[0]);
                    const baseOctave = 4;
                    const octaveOffset = (octave - baseOctave) * 7;
                    
                    let positionIndex;
                    switch(noteName) {
                        case 'C#': positionIndex = 0 + octaveOffset; break;
                        case 'D#': positionIndex = 1 + octaveOffset; break;
                        case 'F#': positionIndex = 3 + octaveOffset; break;
                        case 'G#': positionIndex = 4 + octaveOffset; break;
                        case 'A#': positionIndex = 5 + octaveOffset; break;
                    }
                    
                    const leftOffset = (positionIndex + 1) * (whiteKeyWidth + 2) - (whiteKeyWidth * 0.35);
                    key.style.left = leftOffset + 'px';
                    
                    // Event listeners
                    key.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.onPianoKeyDown(note, key);
                    });
                    
                    key.addEventListener('mouseup', () => this.onPianoKeyUp(note, key));
                    key.addEventListener('mouseleave', () => this.onPianoKeyUp(note, key));
                    
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.onPianoKeyDown(note, key);
                    }, { passive: false });
                    
                    key.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        this.onPianoKeyUp(note, key);
                    }, { passive: false });
                    
                    DOM.pianoKeys.appendChild(key);
                });
            });
        },
        
        // Piano key down handler
        onPianoKeyDown(note, keyElement) {
            keyElement.classList.add('active');
            AudioEngine.startNote(note);
            UI.screenFlash('note');
            GameController.handleNoteInput(note);
        },
        
        // Piano key up handler
        onPianoKeyUp(note, keyElement) {
            keyElement.classList.remove('active');
            AudioEngine.stopNote(note);
        },
        
        // Highlight piano key
        highlightPianoKey(note, highlight = true) {
            const key = DOM.pianoKeys.querySelector(`[data-note="${note}"]`);
            if (key) {
                key.classList.toggle('highlight', highlight);
            }
        },
        
        // Clear all piano highlights
        clearPianoHighlights() {
            DOM.pianoKeys.querySelectorAll('.highlight').forEach(key => {
                key.classList.remove('highlight');
            });
        },
        
        // Build Guitar
        buildGuitar() {
            DOM.guitarFretboard.innerHTML = '';
            
            const strings = ['E4', 'B3', 'G3', 'D3', 'A2', 'E2'];
            const frets = 5;
            
            strings.forEach((openNote, stringIndex) => {
                const stringDiv = document.createElement('div');
                stringDiv.className = 'guitar-string';
                
                for (let fret = 0; fret < frets; fret++) {
                    const fretDiv = document.createElement('div');
                    fretDiv.className = 'guitar-fret';
                    fretDiv.dataset.string = stringIndex;
                    fretDiv.dataset.fret = fret;
                    
                    // Calculate note
                    const note = this.getGuitarNote(openNote, fret);
                    fretDiv.dataset.note = note;
                    fretDiv.textContent = note.replace(/[0-9]/g, '');
                    
                    fretDiv.addEventListener('click', () => {
                        this.onGuitarFretClick(note, fretDiv);
                    });
                    
                    fretDiv.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.onGuitarFretClick(note, fretDiv);
                    }, { passive: false });
                    
                    stringDiv.appendChild(fretDiv);
                }
                
                DOM.guitarFretboard.appendChild(stringDiv);
            });
            
            // Build chord diagram
            this.buildChordDiagram();
            
            // Strum area events
            DOM.strumArea.addEventListener('click', () => this.onStrumAreaClick());
            DOM.strumArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                this.onStrumAreaClick();
            }, { passive: false });
        },
        
        // Get guitar note at fret position
        getGuitarNote(openNote, fret) {
            const noteOrder = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteName = openNote.replace(/[0-9]/g, '');
            let octave = parseInt(openNote.match(/[0-9]/)[0]);
            
            let noteIndex = noteOrder.indexOf(noteName);
            noteIndex += fret;
            
            while (noteIndex >= 12) {
                noteIndex -= 12;
                octave++;
            }
            
            return noteOrder[noteIndex] + octave;
        },
        
        // Guitar fret click handler
        onGuitarFretClick(note, fretElement) {
            fretElement.classList.add('active');
            setTimeout(() => fretElement.classList.remove('active'), 200);
            
            AudioEngine.playGuitar(note, '4n');
            UI.screenFlash('note');
            GameController.handleNoteInput(note);
        },
        
        // Build chord diagram
        buildChordDiagram() {
            DOM.chordDiagram.innerHTML = '';
            
            for (let i = 0; i < 6; i++) {
                const dot = document.createElement('div');
                dot.className = 'chord-dot';
                dot.dataset.string = i;
                DOM.chordDiagram.appendChild(dot);
            }
        },
        
        // Update chord diagram
        updateChordDiagram(chordName) {
            DOM.guitarChordName.textContent = GUITAR_CHORDS[chordName]?.name || chordName;
            
            // Simple visualization - mark all dots as active for the chord
            const dots = DOM.chordDiagram.querySelectorAll('.chord-dot');
            const chord = GUITAR_CHORDS[chordName];
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', chord && i < chord.notes.length);
            });
        },
        
        // Strum area click handler
        onStrumAreaClick() {
            const currentChord = DOM.guitarChordName.textContent;
            const chordKey = Object.keys(GUITAR_CHORDS).find(k => 
                GUITAR_CHORDS[k].name === currentChord || k === currentChord
            );
            
            if (chordKey) {
                AudioEngine.strumChord(chordKey);
                UI.screenFlash('note');
                GameController.handleNoteInput(chordKey);
            }
        },
        
        // Build Drum Pads
        buildDrums() {
            DOM.drumPadGrid.innerHTML = '';
            
            DRUM_PADS.forEach(pad => {
                const padEl = document.createElement('div');
                padEl.className = `drum-pad ${pad.class}`;
                padEl.dataset.drum = pad.id;
                
                padEl.innerHTML = `
                    <span class="drum-pad-icon">${pad.icon}</span>
                    <span class="drum-pad-label">${pad.label}</span>
                    <span class="drum-pad-key">${pad.key.toUpperCase()}</span>
                `;
                
                padEl.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    this.onDrumPadHit(pad.id, padEl);
                });
                
                padEl.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.onDrumPadHit(pad.id, padEl);
                }, { passive: false });
                
                DOM.drumPadGrid.appendChild(padEl);
            });
            
            // BPM slider
            DOM.bpmSlider.addEventListener('input', (e) => {
                DOM.bpmValue.textContent = e.target.value;
            });
        },
        
        // Drum pad hit handler
        onDrumPadHit(drumId, padElement) {
            padElement.classList.add('active');
            setTimeout(() => padElement.classList.remove('active'), 100);
            
            AudioEngine.playDrum(drumId);
            UI.screenFlash('note');
            GameController.handleNoteInput(drumId);
        },
        
        // Highlight drum pad
        highlightDrumPad(drumId, highlight = true) {
            const pad = DOM.drumPadGrid.querySelector(`[data-drum="${drumId}"]`);
            if (pad) {
                pad.classList.toggle('highlight', highlight);
            }
        },
        
        // Clear all drum highlights
        clearDrumHighlights() {
            DOM.drumPadGrid.querySelectorAll('.highlight').forEach(pad => {
                pad.classList.remove('highlight');
            });
        },
        
        // Show correct instrument container
        showInstrument(instrument) {
            DOM.pianoContainer.style.display = instrument === 'piano' ? 'block' : 'none';
            DOM.guitarContainer.style.display = instrument === 'guitar' ? 'block' : 'none';
            DOM.drumsContainer.style.display = instrument === 'drums' ? 'block' : 'none';
        },
        
        // Clear all instrument highlights
        clearAllHighlights() {
            this.clearPianoHighlights();
            this.clearDrumHighlights();
        }
    };

    // ============================================
    // KEYBOARD INPUT HANDLER
    // ============================================

    const KeyboardHandler = {
        activeKeys: new Set(),
        
        init() {
            document.addEventListener('keydown', (e) => this.onKeyDown(e));
            document.addEventListener('keyup', (e) => this.onKeyUp(e));
        },
        
        onKeyDown(e) {
            if (e.repeat) return;
            if (this.activeKeys.has(e.key.toLowerCase())) return;
            
            this.activeKeys.add(e.key.toLowerCase());
            
            // Handle based on current instrument
            if (GameState.instrument === 'piano') {
                const note = KEYBOARD_TO_NOTE[e.key.toLowerCase()];
                if (note) {
                    e.preventDefault();
                    const keyEl = DOM.pianoKeys.querySelector(`[data-note="${note}"]`);
                    if (keyEl) {
                        InstrumentBuilder.onPianoKeyDown(note, keyEl);
                    }
                }
            } else if (GameState.instrument === 'drums') {
                const pad = DRUM_PADS.find(p => p.key.toLowerCase() === e.key.toLowerCase());
                if (pad) {
                    e.preventDefault();
                    const padEl = DOM.drumPadGrid.querySelector(`[data-drum="${pad.id}"]`);
                    if (padEl) {
                        InstrumentBuilder.onDrumPadHit(pad.id, padEl);
                    }
                }
            }
        },
        
        onKeyUp(e) {
            this.activeKeys.delete(e.key.toLowerCase());
            
            if (GameState.instrument === 'piano') {
                const note = KEYBOARD_TO_NOTE[e.key.toLowerCase()];
                if (note) {
                    const keyEl = DOM.pianoKeys.querySelector(`[data-note="${note}"]`);
                    if (keyEl) {
                        InstrumentBuilder.onPianoKeyUp(note, keyEl);
                    }
                }
            }
        }
    };    // ============================================
    // GAME CONTROLLER - MAIN GAME LOGIC
    // ============================================

    const GameController = {
        sequenceTimeout: null,
        noteTimeouts: [],
        
        // Start the game
        async startGame() {
            GameState.reset();
            GameState.isPlaying = true;
            
            // Setup UI
            DOM.gameTitle.textContent = GameState.currentSong?.title || 'Free Play';
            DOM.gameModeLabel.textContent = `${GameState.instrument.toUpperCase()} ‚Ä¢ ${GameState.soundPack.toUpperCase()}`;
            
            UI.updateHUD();
            UI.updateProgress(0, GameState.currentSong?.notes.length || 0);
            UI.setInstruction('Get ready...');
            UI.showTargetNotes([]);
            UI.showListenIndicator(false);
            
            InstrumentBuilder.showInstrument(GameState.instrument);
            InstrumentBuilder.clearAllHighlights();
            
            UI.showScreen('game');
            
            // Countdown
            await UI.showCountdown();
            
            // Start based on mode
            if (GameState.mode === 'freeplay') {
                UI.setInstruction('Play freely! No scoring.');
                GameState.totalNotes = 0;
            } else if (GameState.mode === 'listen') {
                GameState.totalNotes = GameState.currentSong?.notes.length || 0;
                this.playNextSequence();
            } else if (GameState.mode === 'chord') {
                GameState.totalNotes = GameState.currentSong?.notes.length || 0;
                this.playNextChord();
            } else if (GameState.mode === 'rhythm') {
                GameState.totalNotes = GameState.currentSong?.notes.length || 0;
                this.playNextRhythm();
            }
        },
        
        // Play next sequence (Listen & Play mode)
        playNextSequence() {
            if (!GameState.isPlaying) return;
            
            const song = GameState.currentSong;
            if (!song || GameState.currentNoteIndex >= song.notes.length) {
                this.endGame();
                return;
            }
            
            GameState.isListening = true;
            GameState.playedNotes = [];
            
            // Determine sequence length (increases with progress)
            const progress = GameState.currentNoteIndex / song.notes.length;
            GameState.sequenceLength = Math.min(6, 3 + Math.floor(progress * 4));
            
            // Get next sequence
            const endIndex = Math.min(GameState.currentNoteIndex + GameState.sequenceLength, song.notes.length);
            GameState.targetNotes = song.notes.slice(GameState.currentNoteIndex, endIndex);
            
            // UI updates
            UI.setInstruction('Listen carefully...');
            UI.showListenIndicator(true);
            UI.showTargetNotes([]);
            InstrumentBuilder.clearAllHighlights();
            
            // Play the sequence
            const noteDelay = 60000 / song.bpm; // ms per beat
            
            this.noteTimeouts = [];
            
            GameState.targetNotes.forEach((note, index) => {
                const timeout = setTimeout(() => {
                    this.playDemoNote(note);
                }, index * noteDelay);
                this.noteTimeouts.push(timeout);
            });
            
            // After sequence plays, prompt user
            const totalTime = GameState.targetNotes.length * noteDelay;
            
            this.sequenceTimeout = setTimeout(() => {
                GameState.isListening = false;
                GameState.roundStartTime = performance.now();
                
                UI.showListenIndicator(false);
                UI.setInstruction('Your turn! Play it back!');
                UI.showTargetNotes(GameState.targetNotes);
                
                // Highlight expected notes
                GameState.targetNotes.forEach(note => {
                    if (GameState.instrument === 'piano') {
                        InstrumentBuilder.highlightPianoKey(note, true);
                    } else if (GameState.instrument === 'drums') {
                        InstrumentBuilder.highlightDrumPad(note, true);
                    }
                });
                
            }, totalTime + 500);
        },
        
        // Play next chord (Chord Master mode)
        playNextChord() {
            if (!GameState.isPlaying) return;
            
            const song = GameState.currentSong;
            if (!song || GameState.currentNoteIndex >= song.notes.length) {
                this.endGame();
                return;
            }
            
            GameState.playedNotes = [];
            GameState.isListening = false;
            
            const chordName = song.notes[GameState.currentNoteIndex];
            GameState.targetNotes = [chordName];
            
            // Update UI
            UI.setInstruction(`Play: ${GUITAR_CHORDS[chordName]?.name || chordName}`);
            UI.showTargetNotes([chordName]);
            UI.updateProgress(GameState.currentNoteIndex, song.notes.length);
            
            // Update chord diagram
            InstrumentBuilder.updateChordDiagram(chordName);
            
            // Play demo
            setTimeout(() => {
                AudioEngine.strumChord(chordName, 'down', '2n');
            }, 300);
            
            GameState.roundStartTime = performance.now();
        },
        
        // Play next rhythm pattern (Rhythm Rush mode)
        playNextRhythm() {
            if (!GameState.isPlaying) return;
            
            const song = GameState.currentSong;
            if (!song || GameState.currentNoteIndex >= song.notes.length) {
                this.endGame();
                return;
            }
            
            GameState.isListening = true;
            GameState.playedNotes = [];
            
            // Get rhythm sequence
            const sequenceLength = Math.min(4, song.notes.length - GameState.currentNoteIndex);
            GameState.targetNotes = song.notes.slice(GameState.currentNoteIndex, GameState.currentNoteIndex + sequenceLength);
            
            UI.setInstruction('Watch the rhythm...');
            UI.showListenIndicator(true);
            UI.showTargetNotes([]);
            InstrumentBuilder.clearAllHighlights();
            
            // Play rhythm pattern
            const beatTime = 60000 / song.bpm;
            
            this.noteTimeouts = [];
            
            GameState.targetNotes.forEach((drum, index) => {
                const timeout = setTimeout(() => {
                    this.playDemoDrum(drum);
                }, index * beatTime);
                this.noteTimeouts.push(timeout);
            });
            
            // Prompt user after pattern
            const totalTime = GameState.targetNotes.length * beatTime;
            
            this.sequenceTimeout = setTimeout(() => {
                GameState.isListening = false;
                GameState.roundStartTime = performance.now();
                
                UI.showListenIndicator(false);
                UI.setInstruction('Your turn! Match the beat!');
                UI.showTargetNotes(GameState.targetNotes);
                
                // Highlight pads
                GameState.targetNotes.forEach(drum => {
                    InstrumentBuilder.highlightDrumPad(drum, true);
                });
                
            }, totalTime + 400);
        },
        
        // Play a demo note (visual + audio)
        playDemoNote(note) {
            if (GameState.instrument === 'piano') {
                // Visual feedback
                const keyEl = DOM.pianoKeys.querySelector(`[data-note="${note}"]`);
                if (keyEl) {
                    keyEl.classList.add('active');
                    setTimeout(() => keyEl.classList.remove('active'), CONFIG.notePlayDuration * 0.8);
                }
                
                // Audio
                AudioEngine.playPiano(note, '8n');
            } else if (GameState.instrument === 'guitar') {
                AudioEngine.playGuitar(note, '8n');
            }
            
            UI.screenFlash('note');
        },
        
        // Play a demo drum hit
        playDemoDrum(drumId) {
            const padEl = DOM.drumPadGrid.querySelector(`[data-drum="${drumId}"]`);
            if (padEl) {
                padEl.classList.add('active');
                setTimeout(() => padEl.classList.remove('active'), 150);
            }
            
            AudioEngine.playDrum(drumId);
            UI.screenFlash('note');
        },
        
        // Handle note input from player
        handleNoteInput(note) {
            // Free play mode - no scoring
            if (GameState.mode === 'freeplay' || !GameState.isPlaying) {
                return;
            }
            
            // Can't input while listening
            if (GameState.isListening) {
                return;
            }
            
            const expectedIndex = GameState.playedNotes.length;
            const expectedNote = GameState.targetNotes[expectedIndex];
            
            if (!expectedNote) return;
            
            const timeTaken = performance.now() - GameState.roundStartTime;
            
            // Check if correct
            let isCorrect = false;
            
            if (GameState.instrument === 'guitar' && GameState.mode === 'chord') {
                // Chord matching
                isCorrect = (note === expectedNote);
            } else {
                // Note matching
                isCorrect = (note === expectedNote);
            }
            
            if (isCorrect) {
                // Determine perfect or good based on timing
                const isPerfect = timeTaken < CONFIG.perfectWindow * (expectedIndex + 1);
                
                if (isPerfect) {
                    GameState.addScore(CONFIG.perfectScore, true);
                    UI.showFeedback('PERFECT!', 'perfect');
                    UI.screenFlash('perfect');
                } else {
                    GameState.addScore(CONFIG.goodScore, false);
                    UI.showFeedback('GOOD!', 'good');
                    UI.screenFlash('good');
                }
                
                UI.markNoteCorrect(expectedIndex);
                UI.bumpScore();
                
                // Remove highlight
                if (GameState.instrument === 'piano') {
                    InstrumentBuilder.highlightPianoKey(expectedNote, false);
                } else if (GameState.instrument === 'drums') {
                    InstrumentBuilder.highlightDrumPad(expectedNote, false);
                }
                
            } else {
                // Wrong note
                GameState.handleMiss();
                UI.showFeedback('MISS!', 'miss');
                UI.screenFlash('miss');
                UI.markNoteWrong(expectedIndex);
            }
            
            GameState.playedNotes.push(note);
            UI.updateHUD();
            
            // Check if sequence complete
            if (GameState.playedNotes.length >= GameState.targetNotes.length) {
                this.onSequenceComplete();
            }
        },
        
        // Called when player completes a sequence
        onSequenceComplete() {
            InstrumentBuilder.clearAllHighlights();
            
            // Move to next sequence
            GameState.currentNoteIndex += GameState.targetNotes.length;
            UI.updateProgress(GameState.currentNoteIndex, GameState.totalNotes);
            
            // Check if song complete
            if (GameState.currentNoteIndex >= GameState.totalNotes) {
                setTimeout(() => this.endGame(), 800);
                return;
            }
            
            // Next round after delay
            setTimeout(() => {
                if (GameState.mode === 'listen') {
                    this.playNextSequence();
                } else if (GameState.mode === 'chord') {
                    this.playNextChord();
                } else if (GameState.mode === 'rhythm') {
                    this.playNextRhythm();
                }
            }, CONFIG.sequenceDelay);
        },
        
        // End the game
        endGame() {
            GameState.isPlaying = false;
            
            // Clear any pending timeouts
            if (this.sequenceTimeout) {
                clearTimeout(this.sequenceTimeout);
            }
            this.noteTimeouts.forEach(t => clearTimeout(t));
            
            InstrumentBuilder.clearAllHighlights();
            
            // Save score
            let isNewRecord = false;
            if (GameState.currentSong && GameState.mode !== 'freeplay') {
                isNewRecord = HighScores.save(
                    GameState.currentSong.id,
                    GameState.score,
                    GameState.getAccuracy(),
                    GameState.getGrade()
                );
            }
            
            // Show results
            setTimeout(() => {
                UI.showResults(isNewRecord);
            }, 500);
        },
        
        // Exit to menu
        exitToMenu() {
            GameState.isPlaying = false;
            
            // Clear timeouts
            if (this.sequenceTimeout) {
                clearTimeout(this.sequenceTimeout);
            }
            this.noteTimeouts.forEach(t => clearTimeout(t));
            
            InstrumentBuilder.clearAllHighlights();
            UI.showScreen('menu');
            UI.updateMenuStats();
        },
        
        // Retry current song
        retry() {
            if (GameState.currentSong) {
                this.startGame();
            } else {
                this.exitToMenu();
            }
        }
    };

    // ============================================
    // STAR BACKGROUND GENERATOR
    // ============================================

    function createStars() {
        const container = document.getElementById('stars-layer');
        if (!container) return;
        
        container.innerHTML = '';
        
        const starCount = 80;
        
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.top = Math.random() * 100 + '%';
            star.style.left = Math.random() * 100 + '%';
            
            const size = 1 + Math.random() * 2;
            star.style.width = size + 'px';
            star.style.height = size + 'px';
            
            star.style.animationDuration = (2 + Math.random() * 4) + 's';
            star.style.animationDelay = (Math.random() * -5) + 's';
            
            container.appendChild(star);
        }
    }

    // ============================================
    // EVENT SETUP
    // ============================================

    function setupEvents() {
        // ===== INSTRUMENT SELECTION =====
        document.querySelectorAll('.instrument-card').forEach(card => {
            card.addEventListener('click', () => {
                // Remove selected from all
                document.querySelectorAll('.instrument-card').forEach(c => c.classList.remove('selected'));
                
                // Select this one
                card.classList.add('selected');
                
                const instrument = card.dataset.instrument;
                GameState.instrument = instrument;
                AudioEngine.setInstrument(instrument);
                
                // Update sound packs
                const packs = SOUND_PACKS[instrument];
                if (packs) {
                    GameState.soundPack = Object.keys(packs)[0];
                    AudioEngine.setSoundPack(GameState.soundPack);
                }
                UI.updateSoundPacks();
            });
        });
        
        // ===== MODE SELECTION =====
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', () => {
                GameState.mode = card.dataset.mode;
                
                if (GameState.mode === 'freeplay') {
                    // Go directly to game
                    GameState.currentSong = null;
                    GameController.startGame();
                } else {
                    // Show song selection
                    UI.showSongModal();
                }
            });
        });
        
        // ===== START BUTTON =====
        DOM.startBtn.addEventListener('click', async () => {
            // Ensure audio is ready
            await AudioEngine.startContext();
            
            // Default to free play if no mode selected
            if (!GameState.mode) {
                GameState.mode = 'freeplay';
            }
            
            if (GameState.mode === 'freeplay') {
                GameState.currentSong = null;
                GameController.startGame();
            } else {
                UI.showSongModal();
            }
        });
        
        // ===== MODAL =====
        DOM.modalClose.addEventListener('click', () => {
            UI.hideSongModal();
        });
        
        DOM.songModal.addEventListener('click', (e) => {
            if (e.target === DOM.songModal) {
                UI.hideSongModal();
            }
        });
        
        // ===== GAME CONTROLS =====
        DOM.gameBackBtn.addEventListener('click', () => {
            GameController.exitToMenu();
        });
        
        // ===== RESULTS BUTTONS =====
        DOM.resultsRetryBtn.addEventListener('click', () => {
            GameController.retry();
        });
        
        DOM.resultsMenuBtn.addEventListener('click', () => {
            UI.showScreen('menu');
            UI.updateMenuStats();
        });
        
        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Escape to exit
            if (e.key === 'Escape') {
                if (GameState.screen === 'game') {
                    GameController.exitToMenu();
                } else if (DOM.songModal.style.display === 'flex') {
                    UI.hideSongModal();
                }
            }
            
            // Space to start in menu
            if (e.key === ' ' && GameState.screen === 'menu') {
                e.preventDefault();
                DOM.startBtn.click();
            }
        });
        
        // ===== PREVENT ZOOM ON MOBILE =====
        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
        
        // Double tap prevention
        let lastTap = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTap < 300) {
                e.preventDefault();
            }
            lastTap = now;
        }, { passive: false });
    }

    // ============================================
    // INITIALIZATION
    // ============================================

    async function init() {
        console.log('üéµ RAPPERSTORE MELODY MASTER PRO');
        console.log('   Initializing...');
        
        try {
            // Create background stars
            createStars();
            
            // Initialize audio visualizer
            Visualizer.init();
            
            // Initialize audio engine
            await AudioEngine.init();
            
            // Build instruments
            updateLoadingStatus('Building instruments...');
            InstrumentBuilder.buildPiano();
            InstrumentBuilder.buildGuitar();
            InstrumentBuilder.buildDrums();
            
            // Setup sound packs UI
            UI.updateSoundPacks();
            
            // Update menu stats
            UI.updateMenuStats();
            
            // Setup all event listeners
            setupEvents();
            
            // Initialize keyboard handler
            KeyboardHandler.init();
            
            // Hide loading screen
            updateLoadingStatus('Ready to play!');
            setTimeout(() => {
                DOM.loading.classList.add('hidden');
            }, 500);
            
            console.log('‚úÖ Initialization complete!');
            
        } catch (error) {
            console.error('‚ùå Initialization error:', error);
            updateLoadingStatus('Error loading. Please refresh.');
        }
    }

    // ============================================
    // START THE APP
    // ============================================

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    // Handle visibility change (pause audio when tab hidden)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && GameState.isPlaying && GameState.mode !== 'freeplay') {
            // Could implement pause here
            console.log('Tab hidden - game continues');
        }
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        AudioEngine.dispose();
    });

    </script>
</body>
</html>
